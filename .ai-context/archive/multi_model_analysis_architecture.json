{
    "system": "BugtraceAI-CLI Multi-Model Analysis",
    "version": "2.0",
    "architecture": {
        "flow": [
            "ReconAgent",
            "AnalysisAgent",
            "ExploitAgent",
            "SkepticalAgent",
            "ReportingAgent"
        ],
        "components": {
            "ReconAgent": {
                "role": "URL Discovery",
                "capabilities": [
                    "Visual crawling",
                    "Input discovery",
                    "Response capture"
                ],
                "events": {
                    "emits": [
                        "new_url_discovered"
                    ]
                }
            },
            "AnalysisAgent": {
                "role": "Multi-Model URL Analysis",
                "status": "NEW - To Implement",
                "capabilities": [
                    "Multi-model analysis",
                    "Persona-based prompting",
                    "Vulnerability assessment",
                    "Consensus building"
                ],
                "models": {
                    "pentester": {
                        "name": "qwen/qwen-2.5-coder-32b-instruct",
                        "persona": "Experienced Penetration Tester",
                        "focus": [
                            "SQL Injection detection",
                            "XSS patterns",
                            "Template injection",
                            "Path traversal"
                        ]
                    },
                    "bug_bounty_hunter": {
                        "name": "deepseek/deepseek-chat",
                        "persona": "Bug Bounty Hunter",
                        "focus": [
                            "High-impact vulnerabilities",
                            "Critical severity",
                            "Fast exploitation routes",
                            "Maximum payout potential"
                        ]
                    },
                    "code_auditor": {
                        "name": "zhipu/glm-4-plus",
                        "persona": "Meticulous Code Auditor",
                        "focus": [
                            "Coding pattern analysis",
                            "Insecure defaults",
                            "Input validation gaps",
                            "Logic flaws"
                        ]
                    }
                },
                "analysis_process": {
                    "step_1": {
                        "name": "Context Extraction",
                        "actions": [
                            "Fetch URL response",
                            "Extract headers",
                            "Parse HTML (first 5000 chars)",
                            "Extract parameters",
                            "Identify technology stack"
                        ]
                    },
                    "step_2": {
                        "name": "Multi-Model Analysis",
                        "actions": [
                            "Run 3 parallel analyses",
                            "Each model uses different persona",
                            "Each returns JSON with vulnerabilities",
                            "Include confidence and reasoning"
                        ]
                    },
                    "step_3": {
                        "name": "Consolidation",
                        "actions": [
                            "Aggregate all model outputs",
                            "Count votes per vulnerability type",
                            "Calculate average confidence",
                            "Identify consensus (2+ models)",
                            "Prioritize by confidence × severity"
                        ]
                    },
                    "step_4": {
                        "name": "Report Generation",
                        "output": {
                            "url": "string",
                            "framework_detected": "string",
                            "likely_vulnerabilities": [
                                {
                                    "type": "SQLi | XSS | CSTI | XXE | ...",
                                    "confidence": "0.0 - 1.0",
                                    "location": "parameter name or element",
                                    "reasoning": "why this vuln is likely",
                                    "votes": "number of models that detected it",
                                    "recommended_payloads": [
                                        "payload examples"
                                    ]
                                }
                            ],
                            "attack_priority": [
                                "ordered list by confidence × severity"
                            ],
                            "skip_tests": [
                                "vuln types with confidence < 0.3"
                            ]
                        }
                    }
                },
                "events": {
                    "subscribes": [
                        "new_url_discovered"
                    ],
                    "emits": [
                        "url_analyzed"
                    ]
                }
            },
            "ExploitAgent": {
                "role": "Focused Exploitation",
                "status": "MODIFIED - Uses Analysis Reports",
                "capabilities": [
                    "Context-aware testing",
                    "Conditional exploitation",
                    "Threshold-based execution"
                ],
                "new_logic": {
                    "before": {
                        "description": "Test ALL vuln types on every URL",
                        "tests_per_url": [
                            "SQLi",
                            "XSS",
                            "CSTI",
                            "XXE",
                            "RCE",
                            "..."
                        ],
                        "time_per_url": "9 minutes",
                        "tokens_per_url": 5000,
                        "efficiency": "Low - Many wasted attempts"
                    },
                    "after": {
                        "description": "Test ONLY high-confidence vulns from analysis",
                        "process": [
                            "Receive url_analyzed event",
                            "Read analysis report",
                            "Filter by confidence threshold (0.7)",
                            "Execute ONLY high-priority tests",
                            "Skip low-confidence tests"
                        ],
                        "tests_per_url": "1-2 (focused)",
                        "time_per_url": "2.5 minutes",
                        "tokens_per_url": 1500,
                        "efficiency": "High - 70% cost reduction"
                    }
                },
                "test_execution": {
                    "SQLi": {
                        "condition": "confidence >= 0.7",
                        "method": "_ladder_sqli(url, context)",
                        "context_usage": "Use recommended payloads from analysis"
                    },
                    "XSS": {
                        "condition": "confidence >= 0.7",
                        "method": "_ladder_xss(url, context)",
                        "context_usage": "Target specific injection points"
                    },
                    "skip": {
                        "condition": "confidence < 0.3",
                        "action": "Log skip reason and move on"
                    }
                },
                "events": {
                    "subscribes": [
                        "url_analyzed"
                    ],
                    "emits": [
                        "vulnerability_detected"
                    ]
                }
            },
            "SkepticalAgent": {
                "role": "Validation",
                "capabilities": [
                    "Screenshot verification (XSS)",
                    "SQLMap validation (SQLi)",
                    "Auto-approval (non-XSS)"
                ],
                "events": {
                    "subscribes": [
                        "vulnerability_detected"
                    ],
                    "emits": [
                        "finding_verified"
                    ]
                }
            },
            "ReportingAgent": {
                "role": "Final Report Generation",
                "capabilities": [
                    "HTML report creation",
                    "Evidence compilation",
                    "Professional formatting"
                ],
                "events": {
                    "subscribes": [
                        "finding_verified"
                    ]
                }
            }
        }
    },
    "event_flow": {
        "complete_pipeline": [
            {
                "step": 1,
                "agent": "ReconAgent",
                "action": "Discover URL",
                "event": "new_url_discovered",
                "data": {
                    "url": "http://example.com/page.php?id=1",
                    "response": "HTTP response object",
                    "inputs": "Discovered form inputs"
                }
            },
            {
                "step": 2,
                "agent": "AnalysisAgent",
                "action": "Multi-model analysis",
                "receives": "new_url_discovered",
                "process": [
                    "Analyze with Qwen Coder (pentester)",
                    "Analyze with DeepSeek (bug bounty)",
                    "Analyze with GLM-4 (auditor)",
                    "Consolidate results",
                    "Generate priority list"
                ],
                "event": "url_analyzed",
                "data": {
                    "url": "http://example.com/page.php?id=1",
                    "report": {
                        "consensus_vulns": [
                            {
                                "type": "SQLi",
                                "confidence": 0.95,
                                "votes": 3,
                                "location": "parameter 'id'"
                            }
                        ],
                        "possible_vulns": [
                            {
                                "type": "XSS",
                                "confidence": 0.25,
                                "votes": 1,
                                "location": "parameter 'search'"
                            }
                        ],
                        "attack_priority": [
                            "SQLi"
                        ],
                        "skip_tests": [
                            "CSTI",
                            "XXE",
                            "SSRF"
                        ]
                    }
                },
                "time": "30 seconds",
                "tokens": 500
            },
            {
                "step": 3,
                "agent": "ExploitAgent",
                "action": "Focused exploitation",
                "receives": "url_analyzed",
                "process": [
                    "Read analysis report",
                    "Check SQLi confidence: 0.95 >= 0.7 ✅",
                    "Execute _ladder_sqli() with context",
                    "SQLMap validation",
                    "Skip XSS (confidence 0.25 < 0.7)"
                ],
                "event": "vulnerability_detected",
                "data": {
                    "type": "SQLi",
                    "url": "http://example.com/page.php?id=1",
                    "confidence": 1.0,
                    "validated_by": "SQLMap"
                },
                "time": "2 minutes",
                "tokens": 1000
            },
            {
                "step": 4,
                "agent": "SkepticalAgent",
                "action": "Validation",
                "receives": "vulnerability_detected",
                "process": [
                    "Auto-approve (SQLi with SQLMap validation)"
                ],
                "event": "finding_verified",
                "data": {
                    "finding_id": "sqli_1",
                    "severity": "CRITICAL",
                    "proof": "SQLMap output"
                }
            },
            {
                "step": 5,
                "agent": "ReportingAgent",
                "action": "Generate report",
                "receives": "finding_verified",
                "output": "reports/report_*/report.html"
            }
        ]
    },
    "configuration": {
        "bugtraceaicli.conf": {
            "ANALYSIS": {
                "ENABLE_ANALYSIS": true,
                "PENTESTER_MODEL": "qwen/qwen-2.5-coder-32b-instruct",
                "BUG_BOUNTY_MODEL": "deepseek/deepseek-chat",
                "AUDITOR_MODEL": "zhipu/glm-4-plus",
                "CONFIDENCE_THRESHOLD": 0.7,
                "SKIP_THRESHOLD": 0.3,
                "CONSENSUS_VOTES": 2
            },
            "SCANNING": {
                "STOP_ON_CRITICAL": true,
                "CRITICAL_TYPES": "SQLi,RCE,XXE",
                "MANDATORY_SQLMAP_VALIDATION": true,
                "SKIP_VALIDATED_PARAMS": true
            }
        }
    },
    "metrics": {
        "before_analysis_agent": {
            "time_per_url": "9 minutes",
            "tokens_per_url": 5000,
            "tests_per_url": 5,
            "wasted_tests": "80%",
            "cost_per_url": "$0.15"
        },
        "after_analysis_agent": {
            "time_per_url": "2.5 minutes",
            "tokens_per_url": 1500,
            "tests_per_url": "1-2",
            "wasted_tests": "20%",
            "cost_per_url": "$0.045"
        },
        "improvements": {
            "time_saved": "72%",
            "cost_saved": "70%",
            "efficiency_gain": "4x faster",
            "accuracy": "Same or better (focused)"
        }
    },
    "implementation_phases": {
        "phase_1": {
            "name": "Analysis Core",
            "status": "DESIGN COMPLETE",
            "tasks": [
                "Create AnalysisAgent class",
                "Implement multi-model prompts",
                "Build consolidation logic",
                "Event bus integration",
                "Configuration parsing"
            ],
            "estimated_time": "2-3 hours"
        },
        "phase_2": {
            "name": "ExploitAgent Integration",
            "status": "PENDING",
            "tasks": [
                "Update to consume analysis reports",
                "Conditional test execution",
                "Threshold filtering",
                "Context-aware payloads"
            ],
            "estimated_time": "1-2 hours"
        },
        "phase_3": {
            "name": "Testing & Optimization",
            "status": "PENDING",
            "tasks": [
                "Test with testphp.vulnweb.com",
                "Measure actual savings",
                "Tune thresholds",
                "Final report validation"
            ],
            "estimated_time": "1 hour"
        }
    },
    "inspiration": {
        "source": "BugTrace-AI by @yz9yt",
        "url": "https://github.com/yz9yt/BugTrace-AI",
        "key_concepts": [
            "Recursive analysis with multiple runs",
            "Different personas per model",
            "AI-powered consolidation",
            "Analysis depth for reliability",
            "Refinement passes for quality"
        ],
        "adaptations": [
            "Integrated into CLI framework",
            "Event-driven architecture",
            "Real-time exploitation feedback",
            "Combined with existing validation (Conductor V2)"
        ]
    }
}