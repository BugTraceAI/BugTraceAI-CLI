---
phase: 03-interactions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bugtrace/core/ui/tui/widgets/findings_table.py
  - bugtrace/core/ui/tui/screens/modals/__init__.py
  - bugtrace/core/ui/tui/screens/modals/finding_details.py
  - bugtrace/core/ui/tui/styles.tcss
autonomous: true

must_haves:
  truths:
    - "FindingsTable widget exists with sortable, scrollable DataTable"
    - "FindingDetailsModal opens when row selected"
    - "Escape closes modal"
    - "Modal shows full payload, request, response"
  artifacts:
    - path: "bugtrace/core/ui/tui/widgets/findings_table.py"
      provides: "Interactive findings DataTable"
      contains: "class FindingsTable"
    - path: "bugtrace/core/ui/tui/screens/modals/finding_details.py"
      provides: "Finding details modal"
      contains: "class FindingDetailsModal"
---

<objective>
Create the FindingsTable widget and FindingDetailsModal for interactive vulnerability browsing.

Purpose: Users can scroll through findings, click to see full details (payload, request, response), and copy payloads to clipboard.

Output: Two new components ready for integration in Plan 03-03.
</objective>

<execution_context>
@/home/albert/.claude/get-shit-done/workflows/execute-plan.md
@/home/albert/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@bugtrace/core/ui/tui/widgets/findings.py (existing simple widget to enhance)
@bugtrace/core/ui/tui/styles.tcss
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FindingsTable widget</name>
  <files>bugtrace/core/ui/tui/widgets/findings_table.py</files>
  <action>
Create `widgets/findings_table.py` with interactive DataTable:

```python
"""Interactive findings table with sorting and selection."""

from textual.widgets import DataTable
from textual.reactive import reactive
from rich.text import Text
from typing import Optional, Dict, Any, List
from dataclasses import dataclass
from datetime import datetime


@dataclass
class Finding:
    """Represents a security finding."""
    id: str
    severity: str
    finding_type: str
    param: Optional[str]
    payload: Optional[str]
    request: Optional[str]
    response_excerpt: Optional[str]
    time: str
    status: str = "new"


class FindingsTable(DataTable):
    """Interactive findings table with sorting and selection."""

    # Store findings for lookup when row selected
    _findings: reactive[Dict[str, Finding]] = reactive({})

    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.cursor_type = "row"
        self.zebra_stripes = True
        self._findings = {}

    def on_mount(self) -> None:
        """Set up table columns on mount."""
        self.add_columns("Severity", "Type", "Parameter", "Time", "Status")

    def add_finding(
        self,
        finding_type: str,
        details: str,
        severity: str,
        param: Optional[str] = None,
        payload: Optional[str] = None,
        request: Optional[str] = None,
        response_excerpt: Optional[str] = None,
    ) -> None:
        """Add a finding row with severity-based styling."""
        # Generate unique ID
        finding_id = f"finding_{len(self._findings)}_{datetime.now().timestamp()}"

        # Create finding object
        finding = Finding(
            id=finding_id,
            severity=severity.upper(),
            finding_type=finding_type,
            param=param,
            payload=payload or details,
            request=request,
            response_excerpt=response_excerpt,
            time=datetime.now().strftime("%H:%M:%S"),
            status="new",
        )

        # Store for later lookup
        self._findings[finding_id] = finding

        # Style severity text
        severity_styles = {
            "CRITICAL": "bold red",
            "HIGH": "red",
            "MEDIUM": "yellow",
            "LOW": "green",
            "INFO": "dim",
        }
        style = severity_styles.get(finding.severity, "white")
        severity_text = Text(finding.severity, style=style)

        # Add row with finding_id as key for lookup
        self.add_row(
            severity_text,
            finding.finding_type,
            finding.param or "-",
            finding.time,
            finding.status,
            key=finding_id,
        )

    def get_finding(self, row_key: str) -> Optional[Finding]:
        """Get finding by row key."""
        return self._findings.get(str(row_key))

    def action_sort_by_severity(self) -> None:
        """Sort table by severity (Critical first)."""
        self.sort("Severity", reverse=True)

    def action_sort_by_type(self) -> None:
        """Sort table by finding type."""
        self.sort("Type")

    def action_sort_by_time(self) -> None:
        """Sort table by time (newest first)."""
        self.sort("Time", reverse=True)
```

Key features:
- Extends Textual's DataTable with cursor_type="row" for row selection
- Stores Finding objects for retrieval when row selected
- Severity-based text styling with Rich
- Sortable columns via actions
- Scrollable (Textual handles virtualization)
  </action>
  <verify>
Run `python -c "from bugtrace.core.ui.tui.widgets.findings_table import FindingsTable, Finding; print('OK')"` - should print OK.
  </verify>
  <done>
FindingsTable widget created with DataTable extension, severity styling, and finding storage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create modals directory structure</name>
  <files>bugtrace/core/ui/tui/screens/modals/__init__.py</files>
  <action>
Create the modals directory and __init__.py:

```bash
mkdir -p bugtrace/core/ui/tui/screens/modals
```

Create `screens/modals/__init__.py`:

```python
"""Modal screens for BugTraceAI TUI."""

from .finding_details import FindingDetailsModal

__all__ = ["FindingDetailsModal"]
```
  </action>
  <verify>
Run `ls bugtrace/core/ui/tui/screens/modals/` - should show __init__.py.
  </verify>
  <done>
Modals directory created with __init__.py exporting FindingDetailsModal.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create FindingDetailsModal</name>
  <files>bugtrace/core/ui/tui/screens/modals/finding_details.py</files>
  <action>
Create `screens/modals/finding_details.py`:

```python
"""Modal for displaying full finding details."""

from textual.screen import ModalScreen
from textual.widgets import Static, Button, TextArea
from textual.containers import Vertical, Horizontal
from textual.binding import Binding
from textual.app import ComposeResult
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from bugtrace.core.ui.tui.widgets.findings_table import Finding


class FindingDetailsModal(ModalScreen[None]):
    """Modal showing full finding details with request/response."""

    BINDINGS = [
        Binding("escape", "dismiss", "Close"),
        Binding("c", "copy_payload", "Copy Payload"),
    ]

    CSS = """
    FindingDetailsModal {
        align: center middle;
    }

    #modal-container {
        width: 80%;
        height: 80%;
        background: $surface;
        border: thick $primary;
        padding: 1 2;
    }

    #modal-title {
        text-align: center;
        text-style: bold;
        margin-bottom: 1;
    }

    .modal-field {
        margin-bottom: 1;
    }

    .section-header {
        margin-top: 1;
        color: $primary;
        text-style: bold;
    }

    #payload-area, #request-area, #response-area {
        height: 5;
        border: solid $secondary;
        margin-bottom: 1;
    }

    .modal-buttons {
        margin-top: 1;
        align: center middle;
        height: auto;
    }

    .modal-buttons Button {
        margin: 0 1;
    }
    """

    def __init__(self, finding: "Finding", **kwargs):
        super().__init__(**kwargs)
        self.finding = finding

    def compose(self) -> ComposeResult:
        """Compose the modal layout."""
        with Vertical(id="modal-container"):
            yield Static(
                f"[bold]{self.finding.finding_type}[/bold]",
                id="modal-title"
            )

            # Severity with color
            severity_colors = {
                "CRITICAL": "red",
                "HIGH": "red",
                "MEDIUM": "yellow",
                "LOW": "green",
                "INFO": "dim",
            }
            color = severity_colors.get(self.finding.severity, "white")
            yield Static(
                f"Severity: [{color}]{self.finding.severity}[/{color}]",
                classes="modal-field"
            )
            yield Static(
                f"Parameter: {self.finding.param or 'N/A'}",
                classes="modal-field"
            )
            yield Static(
                f"Time: {self.finding.time}",
                classes="modal-field"
            )

            yield Static("[bold]Payload:[/bold]", classes="section-header")
            yield TextArea(
                self.finding.payload or "N/A",
                read_only=True,
                id="payload-area"
            )

            yield Static("[bold]Request:[/bold]", classes="section-header")
            yield TextArea(
                self.finding.request or "N/A",
                read_only=True,
                id="request-area"
            )

            yield Static("[bold]Response (excerpt):[/bold]", classes="section-header")
            yield TextArea(
                self.finding.response_excerpt or "N/A",
                read_only=True,
                id="response-area"
            )

            with Horizontal(classes="modal-buttons"):
                yield Button("Copy Payload", id="copy-btn", variant="primary")
                yield Button("Close", id="close-btn")

    def action_dismiss(self) -> None:
        """Close the modal."""
        self.dismiss()

    def action_copy_payload(self) -> None:
        """Copy payload to clipboard."""
        try:
            import pyperclip
            pyperclip.copy(self.finding.payload or "")
            self.notify("Payload copied to clipboard")
        except ImportError:
            # pyperclip not available - graceful degradation
            self.notify("Clipboard not available (install pyperclip)", severity="warning")
        except Exception as e:
            self.notify(f"Copy failed: {e}", severity="error")

    def on_button_pressed(self, event: Button.Pressed) -> None:
        """Handle button presses."""
        if event.button.id == "copy-btn":
            self.action_copy_payload()
        elif event.button.id == "close-btn":
            self.dismiss()
```

Key features:
- ModalScreen with centered overlay
- Inline CSS for modal styling (self-contained)
- Full finding details: severity, param, time, payload, request, response
- Copy to clipboard with graceful degradation (no pyperclip = warning)
- Escape key and Close button both dismiss
  </action>
  <verify>
Run `python -c "from bugtrace.core.ui.tui.screens.modals import FindingDetailsModal; print('OK')"` - should print OK.
  </verify>
  <done>
FindingDetailsModal created with full finding display, clipboard copy, and escape-to-close.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add modal-related styles to global stylesheet</name>
  <files>bugtrace/core/ui/tui/styles.tcss</files>
  <action>
Append modal and findings-table styles to `styles.tcss`:

```css
/* ===== Findings Table ===== */
#findings-table {
    height: 100%;
    border: solid $primary;
}

#findings-table > .datatable--header {
    background: $primary-darken-2;
    text-style: bold;
}

#findings-table > .datatable--cursor {
    background: $primary;
}

/* ===== Modal Overlay ===== */
ModalScreen {
    background: $background 80%;
}
```

These complement the inline CSS in FindingDetailsModal for consistent theming.
  </action>
  <verify>
Run `grep -c "findings-table" bugtrace/core/ui/tui/styles.tcss` - should return at least 1.
  </verify>
  <done>
Global styles added for FindingsTable and modal overlay.
  </done>
</task>

</tasks>

<verification>
1. **Static verification:**
   - FindingsTable class exists in widgets/findings_table.py
   - FindingDetailsModal class exists in screens/modals/finding_details.py
   - __init__.py exports FindingDetailsModal
   - Styles added to styles.tcss

2. **Runtime verification:**
   - Both modules import without errors
   - `python -m py_compile` passes on all new files

3. **Integration ready:**
   - FindingsTable.get_finding() returns Finding object by row key
   - FindingDetailsModal accepts Finding in constructor
   - Modal dismisses on Escape
</verification>

<success_criteria>
- [ ] FindingsTable widget with sortable, scrollable DataTable
- [ ] Finding dataclass for structured finding storage
- [ ] FindingDetailsModal with full details display
- [ ] Clipboard copy with graceful degradation
- [ ] Escape key closes modal
- [ ] All files import without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-interactions/03-01-SUMMARY.md`
</output>
