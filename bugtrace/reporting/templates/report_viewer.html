<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BugTraceAI | Security Assessment Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vuln-critical': '#991b1b',
                        'vuln-high': '#dc2626',
                        'vuln-medium': '#d97706',
                        'vuln-low': '#2563eb',
                        'vuln-info': '#059669',
                        'brand-slate': '#0f172a',
                        'brand-border': '#1e293b'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap');

        body {
            background-color: #f8fafc;
            color: #1e293b;
            font-family: 'Inter', sans-serif;
        }

        .sidebar {
            background-color: #0f172a;
        }

        .card {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            transition: border-color 0.2s;
        }

        .card:hover {
            border-color: #cbd5e1;
        }

        .badge {
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.65rem;
            padding: 0.25rem 0.5rem;
            letter-spacing: 0.05em;
            border-radius: 0.25rem;
        }

        code {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.9);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            transition: opacity 0.5s;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Print Styles - Optimized for PDF Export via Ctrl+P */
        @media print {

            /* === PAGE SETUP === */
            @page {
                size: A4;
                margin: 0.5cm;
                /* Minimized to reduce browser header/footer space */
            }

            /* === HIDE INTERACTIVE ELEMENTS === */
            .no-print,
            aside.sidebar,
            button,
            select,
            input,
            #loading-overlay,
            #error-modal,
            #modal {
                display: none !important;
            }

            /* === GLOBAL PRINT STYLES === */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            body {
                background: white !important;
                color: #1a1a1a !important;
                font-size: 10pt;
                line-height: 1.4;
                margin: 0;
                padding: 0;
            }

            /* === LAYOUT ADJUSTMENTS === */
            main {
                margin-left: 0 !important;
                padding: 0 !important;
                max-width: 100% !important;
            }

            .max-w-5xl {
                max-width: 100% !important;
            }

            /* === HEADER - PRINT VERSION === */
            main::before {
                content: "BugTraceAI Security Assessment Report";
                display: block;
                font-size: 18pt;
                font-weight: bold;
                color: #1e40af;
                margin-bottom: 20pt;
                padding-bottom: 10pt;
                border-bottom: 2pt solid #1e40af;
            }

            /* === CARDS OPTIMIZATION === */
            .card {
                border: 1px solid #ddd !important;
                background: white !important;
                page-break-inside: avoid;
                margin-bottom: 15pt;
                box-shadow: none !important;
            }

            /* === FINDING CARDS === */
            .finding-card {
                page-break-inside: avoid;
                border: 1.5pt solid #333 !important;
                margin-bottom: 20pt;
            }

            .finding-card .border-b {
                border-bottom: 1pt solid #ccc !important;
                padding: 10pt !important;
            }

            /* === BADGES === */
            .badge {
                border: 1pt solid #333 !important;
                padding: 3pt 6pt !important;
                font-size: 8pt !important;
                font-weight: bold !important;
            }

            /* Severity badges - print-safe colors */
            .bg-vuln-critical {
                background: #fee !important;
                color: #900 !important;
                border-color: #900 !important;
            }

            .bg-vuln-high {
                background: #fdd !important;
                color: #c00 !important;
                border-color: #c00 !important;
            }

            .bg-vuln-medium {
                background: #fed !important;
                color: #d60 !important;
                border-color: #d60 !important;
            }

            .bg-vuln-low {
                background: #ddf !important;
                color: #036 !important;
                border-color: #036 !important;
            }

            .bg-vuln-info {
                background: #f0f0f0 !important;
                color: #666 !important;
                border-color: #666 !important;
            }

            .bg-green-600 {
                background: #dfd !important;
                color: #060 !important;
                border-color: #060 !important;
            }

            .bg-amber-500 {
                background: #fff4dd !important;
                color: #d90 !important;
                border-color: #d90 !important;
            }

            /* === CODE BLOCKS === */
            code,
            pre {
                font-family: 'Courier New', monospace !important;
                font-size: 8pt !important;
                background: #f5f5f5 !important;
                border: 1pt solid #ddd !important;
                padding: 2pt 4pt !important;
                word-wrap: break-word;
                white-space: pre-wrap;
            }

            .bg-slate-900 {
                background: #f8f8f8 !important;
                border: 1pt solid #ccc !important;
                color: #000 !important;
            }

            .text-green-400 {
                color: #006600 !important;
            }

            /* === SECTION HEADERS === */
            h1,
            h2,
            h3,
            h4 {
                page-break-after: avoid;
                color: #1a1a1a !important;
                font-weight: bold;
            }

            h2 {
                font-size: 14pt;
                margin-top: 15pt;
                margin-bottom: 8pt;
                border-bottom: 1pt solid #ccc;
                padding-bottom: 5pt;
            }

            h3 {
                font-size: 12pt;
                margin-top: 10pt;
                margin-bottom: 6pt;
            }

            h4 {
                font-size: 10pt;
                margin-top: 8pt;
                margin-bottom: 4pt;
                text-transform: uppercase;
                color: #555 !important;
            }

            /* === LISTS === */
            ol,
            ul {
                margin: 8pt 0;
                padding-left: 20pt;
            }

            li {
                margin-bottom: 4pt;
            }

            /* === GRID LAYOUT FIX === */
            .grid {
                display: block !important;
            }

            .grid>div {
                margin-bottom: 10pt;
            }

            /* === COLORS FOR PRINT === */
            .bg-blue-50\/50,
            .bg-slate-50\/50 {
                background: #f9f9f9 !important;
            }

            .border-blue-100 {
                border-color: #ccc !important;
            }

            /* === IMAGES === */
            img {
                max-width: 100% !important;
                height: auto !important;
                page-break-inside: avoid;
                display: block;
                margin: 10pt auto;
            }

            /* === FOOTER === */
            footer {
                page-break-inside: avoid;
                margin-top: 30pt;
                padding-top: 15pt;
                border-top: 1pt solid #ccc;
                font-size: 8pt;
                color: #666 !important;
            }

            /* === CHART HANDLING === */
            canvas {
                max-width: 400pt !important;
                height: auto !important;
                page-break-inside: avoid;
            }

            /* === UTILITY OVERRIDES === */
            .text-white {
                color: #000 !important;
            }

            .text-slate-500,
            .text-slate-400 {
                color: #555 !important;
            }

            .text-slate-600,
            .text-slate-700 {
                color: #333 !important;
            }

            /* === SPACING ADJUSTMENTS === */
            .space-y-6>*+*,
            .space-y-8>*+* {
                margin-top: 10pt !important;
            }

            .gap-6,
            .gap-8 {
                gap: 10pt !important;
            }

            /* === PREVENT ORPHANS/WIDOWS === */
            p {
                orphans: 3;
                widows: 3;
            }

            /* === TABLE FORMATTING === */
            table {
                border-collapse: collapse;
                width: 100%;
                page-break-inside: avoid;
            }

            th,
            td {
                border: 1pt solid #ddd;
                padding: 6pt;
                text-align: left;
            }

            th {
                background: #f0f0f0 !important;
                font-weight: bold;
            }
        }
    </style>
    <!-- Load Data Globally (JSONP Style to bypass CORS on local file://) -->
    <script src="engagement_data.js"></script>
</head>

<body class="min-h-screen flex flex-col md:flex-row">
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="loader mb-4"></div>
        <div class="text-xl font-bold">BugTraceAI Reactor</div>
        <div class="text-slate-400 text-sm mt-2">Initializing Tactical Report...</div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 z-[2000] bg-black/80 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl border-t-8 border-red-600">
            <h3 class="text-2xl font-bold text-slate-900 mb-2">Report Load Error</h3>
            <p id="error-message" class="text-slate-600 mb-6">The report could not be loaded or is invalid.</p>
            <div class="space-y-3">
                <button onclick="document.getElementById('file-input').click()"
                    class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-file-import"></i> Browse Local Report (.json)
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="file-input" class="hidden" accept=".json" onchange="handleFileUpload(event)">

    <!-- Sidebar / Header -->
    <aside class="w-full md:w-80 sidebar text-white flex flex-col no-print shrink-0 md:fixed md:h-screen">
        <div class="p-8">
            <div class="flex items-center gap-3 mb-8">
                <div class="w-10 h-10 bg-blue-600 rounded flex items-center justify-center font-bold text-xl">B</div>
                <h1 class="text-xl font-bold tracking-tight">Bugtrace<span class="text-blue-500">AI</span></h1>
            </div>

            <nav class="space-y-4">
                <div class="text-xs uppercase text-slate-500 font-bold tracking-widest mb-4">Assessment Context</div>
                <div>
                    <div class="text-sm text-slate-400 mb-1">Target Host</div>
                    <div id="ui-target-url" class="font-mono text-sm break-all text-blue-400">LOADING...</div>
                </div>
                <div>
                    <div class="text-sm text-slate-400 mb-1">Execution Date</div>
                    <div id="ui-scan-date" class="text-sm">LOADING...</div>
                </div>
                <div>
                    <div class="text-sm text-slate-400 mb-1">Framework Version</div>
                    <div id="ui-tool-version" class="text-sm">v5.0.0</div>
                </div>
            </nav>

            <div class="mt-12 space-y-4">
                <div class="text-xs uppercase text-slate-500 font-bold tracking-widest mb-4">Risk Summary</div>
                <div class="space-y-2" id="severity-filter-buttons">
                    <div class="severity-filter-btn flex justify-between items-center bg-vuln-critical/10 p-2 rounded cursor-pointer hover:bg-vuln-critical/20 transition-all"
                         data-severity="Critical" onclick="filterBySeverity('Critical')">
                        <span class="text-xs font-bold text-red-500">CRITICAL</span>
                        <span id="ui-count-critical" class="font-bold">0</span>
                    </div>
                    <div class="severity-filter-btn flex justify-between items-center bg-vuln-high/10 p-2 rounded cursor-pointer hover:bg-vuln-high/20 transition-all"
                         data-severity="High" onclick="filterBySeverity('High')">
                        <span class="text-xs font-bold text-red-400">HIGH</span>
                        <span id="ui-count-high" class="font-bold">0</span>
                    </div>
                    <div class="severity-filter-btn flex justify-between items-center bg-vuln-medium/10 p-2 rounded cursor-pointer hover:bg-vuln-medium/20 transition-all"
                         data-severity="Medium" onclick="filterBySeverity('Medium')">
                        <span class="text-xs font-bold text-amber-500">MEDIUM</span>
                        <span id="ui-count-medium" class="font-bold">0</span>
                    </div>
                    <div class="severity-filter-btn flex justify-between items-center bg-vuln-low/10 p-2 rounded cursor-pointer hover:bg-vuln-low/20 transition-all"
                         data-severity="Low" onclick="filterBySeverity('Low')">
                        <span class="text-xs font-bold text-blue-400">LOW</span>
                        <span id="ui-count-low" class="font-bold">0</span>
                    </div>
                    <div class="severity-filter-btn flex justify-between items-center bg-vuln-info/10 p-2 rounded cursor-pointer hover:bg-vuln-info/20 transition-all"
                         data-severity="Info" onclick="filterBySeverity('Info')">
                        <span class="text-xs font-bold text-slate-400">INFO</span>
                        <span id="ui-count-info" class="font-bold">0</span>
                    </div>
                    <!-- Clear filter button -->
                    <div class="flex justify-center mt-2">
                        <button onclick="filterBySeverity('all')" class="text-xs text-slate-500 hover:text-white transition-colors">
                            <i class="fas fa-times-circle"></i> Clear Filter
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tech Stack Section -->
            <div id="tech-stack-section" class="mt-8 hidden">
                <div class="text-xs uppercase text-slate-500 font-bold tracking-widest mb-4">Technology Stack</div>
                <div id="ui-tech-stack" class="space-y-2 text-xs">
                    <!-- Populated by JS -->
                </div>
            </div>

            <div class="mt-8 border-t border-slate-800 pt-8 no-print space-y-3">
                <!-- Export PDF Button -->
                <button onclick="window.print()"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 shadow-lg hover:shadow-xl">
                    <i class="fas fa-file-pdf"></i> EXPORT PDF
                </button>

                <!-- Load Different Report -->
                <button onclick="document.getElementById('file-input').click()"
                    class="text-xs text-slate-400 hover:text-white transition-colors flex items-center gap-2">
                    <i class="fas fa-sync"></i> LOAD DIFFERENT REPORT
                </button>
            </div>
        </div>
        <div class="mt-auto p-8 border-t border-slate-800">
            <div class="text-[10px] text-slate-500 leading-relaxed uppercase tracking-tighter">
                Highly confidential security assessment. Unauthorized reproduction or distribution is prohibited.
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 md:ml-80 p-6 md:p-12">
        <div class="max-w-5xl mx-auto">
            <!-- Summary Dashboard -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-12">
                <div class="lg:col-span-2 card p-8 flex flex-col">
                    <h2 class="text-lg font-bold mb-6 flex items-center gap-2">
                        <i class="fas fa-chart-pie text-slate-400"></i>
                        Vulnerability Distribution
                    </h2>
                    <div class="flex flex-1 items-center justify-center p-4">
                        <div class="w-full max-w-[350px]">
                            <canvas id="riskChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div id="ui-validation-card" class="card p-6 border-l-4 border-amber-600 bg-amber-50/30">
                        <div class="text-xs text-slate-500 mb-1 font-bold">VALIDATION STATUS</div>
                        <div id="ui-count-validated-total" class="text-3xl font-bold">0/0</div>
                        <div id="ui-validation-text" class="text-xs text-amber-600 mt-2">
                            ‚ö†Ô∏è Potential (Requires Validation)
                        </div>
                    </div>
                    <div class="card p-6">
                        <div class="text-xs text-slate-500 mb-1 font-bold">URLs SCANNED</div>
                        <div id="ui-urls-scanned" class="text-3xl font-bold">0</div>
                    </div>
                    <div class="card p-6">
                        <div class="text-xs text-slate-500 mb-1 font-bold">SCAN DURATION</div>
                        <div id="ui-scan-duration" class="text-3xl font-bold">0s</div>
                    </div>
                </div>
            </div>

            <!-- Findings List -->
            <div class="mb-8 flex flex-wrap items-center justify-between gap-4 border-b pb-4">
                <h2 class="text-2xl font-bold">Detailed Technical Findings</h2>
                <div class="flex flex-wrap items-center gap-3">
                    <select id="filterSeverity" onchange="applyFilters()"
                        class="px-3 py-2 text-sm border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="all">All Severities</option>
                        <option value="Critical">üî¥ Critical</option>
                        <option value="High">üü† High</option>
                        <option value="Medium">üü° Medium</option>
                        <option value="Low">üîµ Low</option>
                        <option value="Info">üü¢ Info</option>
                    </select>

                    <select id="filterValidation" onchange="applyFilters()"
                        class="px-3 py-2 text-sm border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="all">All Findings</option>
                        <option value="verified">‚úÖ Verified Only</option>
                        <option value="potential">‚ö†Ô∏è Potential Only</option>
                    </select>

                    <span id="filterCount" class="text-sm text-slate-500 ml-2">
                        Showing <span id="visibleCount">0</span> of <span id="totalFindings">0</span>
                    </span>
                </div>
            </div>

            <div id="findingsContainer" class="space-y-6">
                <!-- JS will inject findings here -->
            </div>

            <!-- Nuclei / Infrastructure Findings Section -->
            <div id="nuclei-section" class="mt-12 hidden">
                <div class="mb-8 flex flex-wrap items-center justify-between gap-4 border-b pb-4">
                    <h2 class="text-2xl font-bold flex items-center gap-3">
                        <i class="fas fa-radar text-purple-500"></i>
                        Infrastructure & Technology Findings
                    </h2>
                    <span class="text-sm text-slate-500">
                        <span id="nuclei-count">0</span> detections via Nuclei
                    </span>
                </div>
                <div id="nucleiContainer" class="space-y-4">
                    <!-- JS will inject nuclei findings here -->
                </div>
            </div>

            <!-- Audit Footer -->
            <footer
                class="mt-20 border-t pt-8 flex flex-col md:flex-row justify-between items-center text-slate-400 text-xs text-center md:text-left gap-4">
                <div>
                    <div class="font-bold mb-1">AUDIT SIGNATURE</div>
                    <div id="ui-audit-hash" class="font-mono">HASH: 0xDEADBEEF</div>
                </div>
                <div>
                    <p>¬© 2026 BugtraceAI Professional Edition</p>
                    <p>Generated for authorized compliance auditing only.</p>
                </div>
            </footer>
        </div>
    </main>

    <!-- Modal Lightbox -->
    <div id="modal"
        class="fixed inset-0 z-[100] bg-slate-900/95 hidden items-center justify-center p-4 md:p-12 no-print"
        onclick="closeLightbox()">
        <img id="modalImg" src="" class="max-w-full max-h-full shadow-2xl border-4 border-white rounded">
        <button class="absolute top-8 right-8 text-white text-4xl">&times;</button>
    </div>

    <!-- Main Logic -->
    <script>
        let currentChart = null;

        // Security: Escape HTML to prevent payload execution in the report itself
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return "";
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Check for embedded data first (for backward compatibility if we want to still bake it)
            const embedded = document.getElementById('embedded-data');
            if (embedded && embedded.textContent.trim()) {
                try {
                    renderReport(JSON.parse(embedded.textContent));
                    return;
                } catch (e) { console.error("Embedded data corrupt"); }
            }

            // AUTO-LOAD from global variable (JSONP style)
            if (window.BUGTRACE_REPORT_DATA) {
                renderReport(window.BUGTRACE_REPORT_DATA);
                return;
            }

            // Fallback: If no global data, show error or manual load
            showError("No report data found. Please ensure engagement_data.js is in the same folder.");
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    renderReport(data);
                } catch (err) {
                    showError("Invalid JSON file format.");
                }
            };
            reader.readAsText(file);
        }

        function showError(msg) {
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('error-modal').classList.remove('hidden');
            document.getElementById('error-modal').classList.add('flex');
            document.getElementById('error-message').innerText = msg;
        }

        function renderReport(data) {
            // Global access for interaction
            window.reportData = data;

            // Signature Check: Handle root level or meta level
            const signature = data.report_signature || (data.meta && data.meta.report_signature);
            if (signature !== "BUGTRACE_AI_REPORT_V5") {
                showError("The selected file is not a valid BugTraceAI V5 Report (Missing Signature). Found: " + signature);
                return;
            }

            document.getElementById('error-modal').classList.add('hidden');
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.add('opacity-0');
            overlay.classList.add('pointer-events-none');
            setTimeout(() => overlay.classList.add('hidden'), 500);

            // Data Mapping (Handle structure mismatch)
            const targetUrl = data.target_url || (data.meta && data.meta.target) || "Unknown Target";
            const scanDate = data.scan_date || (data.meta && data.meta.scan_date) || new Date().toISOString();
            const toolVersion = data.tool_version || (data.meta && data.meta.tool_version) || "5.0.0";

            // Update Sidebar Info
            document.getElementById('ui-target-url').innerText = targetUrl;
            document.getElementById('ui-scan-date').innerText = new Date(scanDate).toLocaleString();
            document.getElementById('ui-tool-version').innerText = 'v' + (escapeHtml(toolVersion));

            // Stats Mapping
            const findings = data.findings || [];
            // If stats object is missing, try summary or calculate
            const stats = data.stats || data.summary || {};
            const totalFindings = stats.total_findings || findings.length;

            // Calculate critical/high/medium from findings if not in stats (or if stats format differs)
            let critical = 0, high = 0, medium = 0;
            if (stats.by_severity) {
                critical = stats.by_severity.critical || 0;
                high = stats.by_severity.high || 0;
                medium = stats.by_severity.medium || 0;
            } else {
                critical = findings.filter(f => (f.severity || '').toLowerCase() === 'critical').length;
                high = findings.filter(f => (f.severity || '').toLowerCase() === 'high').length;
                medium = findings.filter(f => (f.severity || '').toLowerCase() === 'medium').length;
            }

            // Calculate LOW and INFO
            let low = 0, infoCount = 0;
            if (stats.by_severity) {
                low = stats.by_severity.low || 0;
                infoCount = stats.by_severity.info || 0;
            } else {
                low = findings.filter(f => (f.severity || '').toLowerCase() === 'low').length;
                infoCount = findings.filter(f => ['info', 'information'].includes((f.severity || '').toLowerCase())).length;
            }

            document.getElementById('ui-count-critical').innerText = critical;
            document.getElementById('ui-count-high').innerText = high;
            document.getElementById('ui-count-medium').innerText = medium;
            document.getElementById('ui-count-low').innerText = low;
            document.getElementById('ui-count-info').innerText = infoCount;

            // V5 compatibility: Check for status string instead of validated boolean
            const validatedCount = findings.filter(f =>
                f.validated === true ||
                (f.status && f.status.includes('VALIDATED_CONFIRMED'))
            ).length;
            // V5 compatibility: finding types are specific (XSS, SQLi, etc.) not generic "vulnerability"
            const totalVulns = findings.filter(f => {
                const type = (f.type || '').toUpperCase();
                return type !== 'INFO' && type !== 'INFORMATION' && !['Info', 'Information'].includes(f.severity);
            }).length || findings.length;

            document.getElementById('ui-count-validated-total').innerText = `${validatedCount}/${totalVulns}`;
            const valCard = document.getElementById('ui-validation-card');
            const valText = document.getElementById('ui-validation-text');

            if (validatedCount > 0) {
                valCard.className = "card p-6 border-l-4 border-green-600 bg-green-50/30";
                valText.innerText = "‚úÖ Confirmed via Browser/Validation Pipeline";
                valText.className = "text-xs text-green-600 mt-2";
            } else {
                valCard.className = "card p-6 border-l-4 border-amber-600 bg-amber-50/30";
                valText.innerText = "‚ö†Ô∏è Potential (Requires Validation)";
                valText.className = "text-xs text-amber-600 mt-2";
            }

            // V5 compatibility: use the already-aliased stats variable instead of data.stats
            document.getElementById('ui-urls-scanned').innerText = stats.urls_scanned || stats.total_urls || 0;
            document.getElementById('ui-scan-duration').innerText = Math.round(stats.duration_seconds || stats.scan_duration || 0) + 's';

            document.getElementById('totalFindings').innerText = findings.length;
            document.getElementById('ui-audit-hash').innerText = "HASH: " + Math.random().toString(36).substring(7).toUpperCase();

            // Render Findings
            const container = document.getElementById('findingsContainer');
            container.innerHTML = '';

            (data.findings || []).forEach((f, i) => {
                const card = document.createElement('div');
                card.className = `card overflow-hidden finding-card`;
                // V5 compatibility: normalize severity to Title Case for filtering
                const normalizedSeverity = f.severity ?
                    f.severity.charAt(0).toUpperCase() + f.severity.slice(1).toLowerCase() : 'Info';
                card.dataset.severity = normalizedSeverity;
                // V5 compatibility: check status string or boolean
                const isValidated = f.validated === true || (f.status && f.status.includes('VALIDATED_CONFIRMED'));
                card.dataset.validated = isValidated;

                let sevClass = "bg-vuln-info";
                const sevUpper = normalizedSeverity;
                if (sevUpper === "Critical") sevClass = "bg-vuln-critical";
                else if (sevUpper === "High") sevClass = "bg-vuln-high";
                else if (sevUpper === "Medium") sevClass = "bg-vuln-medium";
                else if (sevUpper === "Low") sevClass = "bg-vuln-low";

                card.innerHTML = `
                    <div class="p-6 border-b bg-slate-50/50 flex flex-wrap items-center justify-between gap-4">
                        <div class="flex items-center gap-4">
                            <span class="badge ${sevClass} text-white">${normalizedSeverity}</span>
                            ${f.cvss_score ? `<span class="badge bg-slate-800 text-white" title="${escapeHtml(f.cvss_vector)}">CVSS ${f.cvss_score}</span>` : ''}
                            ${isValidated ? '<span class="badge bg-green-600 text-white">‚úÖ VERIFIED</span>' : '<span class="badge bg-amber-500 text-white">‚ö†Ô∏è POTENTIAL</span>'}
                            <h3 class="font-bold text-lg">${escapeHtml(f.title || f.type || 'Finding')}</h3>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="copyFindingMarkdown(${i})" class="text-xs font-bold bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-1 rounded flex items-center gap-2 transition-colors" title="Copy Triager-Ready Markdown">
                                <i class="fas fa-file-code"></i> COPY MD
                            </button>
                            <div class="text-xs font-mono text-slate-500 bg-white px-3 py-1 border rounded">
                                ${escapeHtml(f.url || (f.metadata && f.metadata.url) || targetUrl)}
                            </div>
                        </div>
                    </div>

                    <div class="p-8 grid grid-cols-12 gap-8">
                        <!-- Left Column: Description & Steps -->
                        <div class="md:col-span-12 lg:col-span-7 space-y-8">
                            
                            ${f.cvss_score ? `
                            <div class="bg-indigo-50/50 p-6 rounded-lg border border-indigo-100">
                                <h4 class="text-xs font-black text-indigo-600 uppercase mb-4 tracking-widest flex items-center gap-2">
                                    <i class="fas fa-brain"></i> AI Security Intelligence
                                </h4>
                                <div class="flex flex-wrap items-center gap-6 mb-4">
                                     <div class="flex items-center gap-2">
                                        <span class="text-xs font-bold text-slate-500 uppercase">CVSS Score</span>
                                        <span class="text-2xl font-bold text-indigo-700">${f.cvss_score}</span>
                                     </div>
                                     <div class="flex items-center gap-2">
                                        <span class="text-xs font-bold text-slate-500 uppercase">Vector</span>
                                        <code class="text-xs bg-white px-2 py-1 rounded border border-indigo-200 text-indigo-600 font-mono" title="${escapeHtml(f.cvss_vector)}">${escapeHtml(f.cvss_vector && f.cvss_vector.length > 30 ? f.cvss_vector.substring(0, 30) + '...' : f.cvss_vector)}</code>
                                     </div>
                                     ${f.cve ? `<div class="flex items-center gap-2">
                                        <span class="text-xs font-bold text-slate-500 uppercase">CVE</span>
                                        <a href="https://nvd.nist.gov/vuln/detail/${f.cve}" target="_blank" class="text-xs bg-red-100 px-2 py-1 rounded border border-red-200 text-red-700 font-bold hover:bg-red-200 transition-colors">${escapeHtml(f.cve)}</a>
                                     </div>` : ''}
                                </div>
                                ${f.cvss_rationale ? `
                                <div class="text-sm text-slate-700 leading-relaxed bg-white/50 p-3 rounded border border-indigo-100 italic">
                                    "${escapeHtml(f.cvss_rationale)}"
                                </div>` : ''}
                            </div>
                            ` : ''}

                            <div>
                                <h4 class="text-xs font-black text-slate-400 uppercase mb-3 tracking-widest">Executive Description</h4>
                                <div class="bg-slate-900 rounded p-3 group relative">
                                    <code class="text-green-400 text-xs break-all leading-relaxed whitespace-pre-wrap font-mono">${escapeHtml(f.description)}</code>
                                    <button class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-slate-400 hover:text-white" onclick="copyToClipboard(this.previousElementSibling.innerText)">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>

                            ${f.exploitation_details ? `
                            <div class="bg-red-50/50 p-6 rounded-lg border-l-4 border-red-500">
                                <h4 class="text-xs font-black text-red-600 uppercase mb-4 tracking-widest flex items-center gap-2">
                                    <i class="fas fa-crosshairs"></i> Exploitation Analysis
                                </h4>
                                <div class="prose prose-sm max-w-none">
                                    <div class="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap bg-white/70 p-4 rounded border border-red-200">${escapeHtml(f.exploitation_details)}</div>
                                </div>
                                <button class="mt-3 text-xs font-bold bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1.5 rounded flex items-center gap-2 transition-colors" onclick="copyToClipboard(this.previousElementSibling.querySelector('div').innerText)">
                                    <i class="fas fa-copy"></i> Copy Full Analysis
                                </button>
                            </div>
                            ` : ''}

                            ${f.sqli_metadata ? `
                            <div class="bg-purple-50/50 p-6 rounded-lg border border-purple-100">
                                <h4 class="text-xs font-black text-purple-600 uppercase mb-4 tracking-widest flex items-center gap-2">
                                    <i class="fas fa-database"></i> SQL Injection Analysis
                                </h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div>
                                        <span class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Technique</span>
                                        <span class="text-sm font-bold text-purple-700">${escapeHtml(f.sqli_metadata.technique || 'Unknown')}</span>
                                    </div>
                                    ${f.sqli_metadata.database_type ? `
                                    <div>
                                        <span class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Database</span>
                                        <span class="text-sm font-bold text-purple-700">${escapeHtml(f.sqli_metadata.database_type)}</span>
                                    </div>
                                    ` : ''}
                                    <div>
                                        <span class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Detection</span>
                                        <span class="text-sm font-bold text-purple-700">${escapeHtml(f.sqli_metadata.detection_tool || 'Automated')}</span>
                                    </div>
                                    <div>
                                        <span class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Parameter</span>
                                        <code class="text-sm font-mono bg-white px-2 py-1 rounded border text-purple-600">${escapeHtml(f.parameter || 'N/A')}</code>
                                    </div>
                                    
                                    ${f.sqli_metadata.exploit_url ? `
                                    <div class="col-span-full mt-2">
                                        <a href="${escapeHtml(f.sqli_metadata.exploit_url_encoded || f.sqli_metadata.exploit_url)}" target="_blank" class="inline-flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition-colors text-sm">
                                            <i class="fas fa-bomb"></i> Launch Exploit (One-Click)
                                        </a>
                                        <div class="text-[10px] text-slate-500 mt-1">WARNING: This will execute the payload against the target.</div>
                                    </div>
                                    ` : ''}

                                    ${f.sqli_metadata.extracted_data && (f.sqli_metadata.extracted_data.tables.length > 0 || f.sqli_metadata.extracted_data.databases.length > 0) ? `
                                    <div class="col-span-full mt-4 bg-white p-4 rounded border border-purple-200">
                                        <span class="text-[10px] font-bold text-slate-500 uppercase block mb-2">Exfiltrated Data (Proof of Impact)</span>
                                        ${f.sqli_metadata.extracted_data.databases.length > 0 ? `
                                            <div class="mb-2">
                                                <span class="text-xs font-bold text-purple-700">Databases:</span>
                                                <div class="flex flex-wrap gap-2 mt-1">
                                                    ${f.sqli_metadata.extracted_data.databases.map(d => `<span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded font-mono border border-purple-200">${escapeHtml(d)}</span>`).join('')}
                                                </div>
                                            </div>
                                        ` : ''}
                                        ${f.sqli_metadata.extracted_data.tables.length > 0 ? `
                                            <div>
                                                <span class="text-xs font-bold text-purple-700">Tables:</span>
                                                <div class="flex flex-wrap gap-2 mt-1">
                                                    ${f.sqli_metadata.extracted_data.tables.map(t => `<span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded font-mono border border-indigo-200">${escapeHtml(t)}</span>`).join('')}
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                    ` : ''}
                                </div>
                                ${f.sqli_metadata.raw_evidence ? `
                                <div class="mt-4">
                                    <span class="text-[10px] font-bold text-slate-500 uppercase block mb-2">Raw Evidence</span>
                                    <div class="bg-slate-900 rounded p-3 group relative">
                                        <code class="text-green-400 text-xs break-all leading-relaxed whitespace-pre-wrap font-mono">${escapeHtml(f.sqli_metadata.raw_evidence.substring(0, 500))}</code>
                                        <button class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-slate-400 hover:text-white" onclick="copyToClipboard(this.previousElementSibling.innerText)">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            ` : ''}

                            <div class="bg-blue-50/50 p-6 rounded-lg border border-blue-100">
                                <h4 class="text-xs font-black text-blue-500 uppercase mb-4 tracking-widest flex items-center gap-2">
                                    <i class="fas fa-shoe-prints"></i> Reproduction Steps
                                </h4>
                                <div class="bg-slate-900 rounded p-3 group relative">
                                    <ol class="list-decimal list-inside space-y-1 text-xs text-green-400 font-mono break-all">
                                        ${(f.reproduction && f.reproduction.steps ? f.reproduction.steps : (f.metadata && f.metadata.reproduction_steps) || [
                        `Navigate to ${f.url || (f.metadata && f.metadata.url) || targetUrl}`,
                        `Identify the parameter '${f.parameter || (f.metadata && f.metadata.parameter) || 'target_param'}'`,
                        `Inject the payload provided in the Technical Proof below.`,
                        `Observe the application response or behavior.`
                    ]).map(step => `<li>${escapeHtml(step)}</li>`).join('')}
                                    </ol>
                                    <button class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-slate-400 hover:text-white" onclick="copyToClipboard(this.previousElementSibling.innerText)">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>

                                    <div class="mt-6">
                                     <h4 class="text-[10px] font-black text-blue-400 uppercase mb-2 tracking-widest">Reproduction Command</h4>
                                    <div class="bg-slate-900 rounded p-3 group relative">
                                        <code class="text-green-400 text-xs break-all leading-relaxed whitespace-pre-wrap font-mono">${escapeHtml((() => {
                                            // 2026-01-23 FIX: Use reproduction command if available (SQLMap for SQLi)
                                            const meta = f.metadata || {};
                                            const vuln_type = (f.type || f.title || '').toUpperCase();
                                            // Priority 1: Direct reproduction string
                                            if (typeof f.reproduction === 'string' && f.reproduction.trim()) {
                                                return f.reproduction;
                                            }
                                            // Priority 2: reproduction in metadata (where collector stores it)
                                            if (typeof meta.reproduction === 'string' && meta.reproduction.trim()) {
                                                return meta.reproduction;
                                            }
                                            // Priority 3: reproduction.curl (legacy object format)
                                            if (f.reproduction && f.reproduction.curl) {
                                                return f.reproduction.curl;
                                            }
                                            // Priority 4: Generate appropriate command based on vuln type
                                            const url = f.url || meta.url || targetUrl;
                                            const param = f.parameter || meta.parameter;
                                            const payload = f.payload || meta.payload || 'PAYLOAD';
                                            if (vuln_type.includes('SQLI') || vuln_type.includes('SQL')) {
                                                // For SQLi, suggest sqlmap command
                                                return param ? 'sqlmap -u "' + url + '" -p ' + param + ' --batch --dbs' : 'sqlmap -u "' + url + '" --batch --dbs';
                                            }
                                            // Default: Show URL and manual testing note
                                            return '# Vulnerable endpoint: ' + url + (param ? '\\n# Parameter: ' + param : '') + '\\n# Payload: ' + payload;
                                        })())}</code>
                                        <button class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-slate-400 hover:text-white" onclick="copyToClipboard(this.previousElementSibling.innerText)">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                </div>

                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-8">
                                    <div>
                                        <h4 class="text-xs font-black text-red-400 uppercase mb-3 tracking-widest">Risk Impact</h4>
                                        <p class="text-sm text-slate-600">${escapeHtml(f.impact || "Direct compromise of target component.")}</p>
                                    </div>
                                    <div>
                                        <h4 class="text-xs font-black text-blue-500 uppercase mb-3 tracking-widest">Remediation Strategy</h4>
                                        <p class="text-sm text-slate-600">${escapeHtml(f.remediation || "Implement input sanitization and output encoding.")}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="md:col-span-12 lg:col-span-5 space-y-8">
                                ${f.evidence && f.evidence.length > 0 || (f.validation && f.validation.screenshot) ? `
                                <div>
                                    <h4 class="text-xs font-black text-slate-400 uppercase mb-3 tracking-widest">Technical Proof</h4>
                                    <div class="space-y-3">
                                    ${(f.validation && f.validation.screenshot ? [{
                            description: "Screenshot available",
                            content: "See 'Browser Validation' section below for image."
                        }] : []).concat(f.evidence || []).map(ev => `
                                    <div class="bg-slate-900 rounded p-4 group relative">
                                        <div class="text-[10px] text-slate-500 font-mono mb-2 uppercase">${escapeHtml(ev.description || "Evidence")}</div>
                                        <code class="text-green-400 text-xs break-all leading-relaxed whitespace-pre-wrap">${escapeHtml(ev.content || ev)}</code>
                                        <button class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-slate-400 hover:text-white" onclick="copyToClipboard(event.target.closest('.group').querySelector('code').innerText)">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                    `).join('')}
                                    ${(!f.evidence && (!f.validation || !f.validation.screenshot)) ? '<div class="text-slate-400 text-xs italic">No additional evidence provided.</div>' : ''}
                                </div>
                                </div>
                                ` : ''}

                                ${f.screenshot_path || (f.validation && f.validation.screenshot) ? `
                                <div>
                                    <h4 class="text-xs font-black text-slate-400 uppercase mb-3 tracking-widest">Browser Validation</h4>
                                    <div class="border rounded bg-slate-100 p-1 cursor-zoom-in group overflow-hidden" onclick="openLightbox('./${f.screenshot_path || (f.validation && f.validation.screenshot)}')">
                                        <img src="./${f.screenshot_path || (f.validation && f.validation.screenshot)}" alt="PoC" class="w-full h-auto grayscale-[0.5] group-hover:grayscale-0 transition-all duration-300">
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            applyFilters();
            renderChart([critical, high, medium, low, infoCount]);

            // Render Infrastructure section (Tech Stack + Nuclei)
            renderInfrastructure(data.infrastructure || {});
        }

        function renderInfrastructure(infrastructure) {
            const techStack = infrastructure.tech_stack || {};
            const nucleiFindings = infrastructure.nuclei_findings || [];

            // Render Tech Stack in Sidebar
            const techStackSection = document.getElementById('tech-stack-section');
            const techStackContainer = document.getElementById('ui-tech-stack');

            const allTech = [
                ...(techStack.frameworks || []).map(t => ({ name: t, type: 'Framework' })),
                ...(techStack.servers || []).map(t => ({ name: t, type: 'Server' })),
                ...(techStack.languages || []).map(t => ({ name: t, type: 'Language' }))
            ];

            if (allTech.length > 0) {
                techStackSection.classList.remove('hidden');
                techStackContainer.innerHTML = allTech.map(t => `
                    <div class="flex items-center gap-2 text-slate-300">
                        <i class="fas fa-microchip text-purple-400 w-4"></i>
                        <span>${escapeHtml(t.name)}</span>
                        <span class="text-slate-500 text-[10px]">${escapeHtml(t.type)}</span>
                    </div>
                `).join('');
            }

            // Render Nuclei Findings
            const nucleiSection = document.getElementById('nuclei-section');
            const nucleiContainer = document.getElementById('nucleiContainer');

            if (nucleiFindings.length > 0) {
                nucleiSection.classList.remove('hidden');
                document.getElementById('nuclei-count').textContent = nucleiFindings.length;

                nucleiContainer.innerHTML = nucleiFindings.map((f, i) => {
                    const sevClass = getSeverityClass(f.severity);
                    const typeName = (f.type || '').replace('NUCLEI:', '');

                    return `
                        <div class="card p-4 border-l-4 ${sevClass.border}">
                            <div class="flex flex-wrap items-center justify-between gap-3">
                                <div class="flex items-center gap-3">
                                    <span class="badge ${sevClass.bg} text-white">${escapeHtml(f.severity)}</span>
                                    <span class="font-bold">${escapeHtml(typeName)}</span>
                                </div>
                                <code class="text-xs bg-slate-100 px-2 py-1 rounded">${escapeHtml(f.url)}</code>
                            </div>
                            ${f.description ? `<p class="text-sm text-slate-600 mt-2">${escapeHtml(f.description)}</p>` : ''}
                            <div class="mt-2 text-xs text-slate-400">
                                <i class="fas fa-tag"></i> Template: <code>${escapeHtml(f.payload || 'unknown')}</code>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function getSeverityClass(severity) {
            const sev = (severity || 'INFO').toUpperCase();
            switch(sev) {
                case 'CRITICAL': return { bg: 'bg-vuln-critical', border: 'border-vuln-critical' };
                case 'HIGH': return { bg: 'bg-vuln-high', border: 'border-vuln-high' };
                case 'MEDIUM': return { bg: 'bg-vuln-medium', border: 'border-vuln-medium' };
                case 'LOW': return { bg: 'bg-vuln-low', border: 'border-vuln-low' };
                default: return { bg: 'bg-vuln-info', border: 'border-vuln-info' };
            }
        }

        function renderChart(counts) {
            if (currentChart) currentChart.destroy();
            const chartCtx = document.getElementById('riskChart').getContext('2d');
            currentChart = new Chart(chartCtx, {
                type: 'radar',
                data: {
                    labels: ['Critical', 'High', 'Medium', 'Low', 'Info'],
                    datasets: [{
                        label: 'Risk Vector',
                        data: counts,
                        backgroundColor: 'rgba(37, 99, 235, 0.4)',
                        borderColor: '#2563eb',
                        borderWidth: 2,
                        pointBackgroundColor: '#2563eb',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            ticks: { display: false, stepSize: 1 },
                            grid: { color: '#e2e8f0' },
                            angleLines: { color: '#e2e8f0' },
                            pointLabels: {
                                font: { size: 11, weight: 'bold' },
                                color: '#64748b'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            const notice = document.createElement('div');
            notice.className = 'fixed bottom-8 right-8 bg-slate-800 text-white px-6 py-3 rounded-full text-sm shadow-xl z-50';
            notice.innerText = 'Evidence copied to clipboard';
            document.body.appendChild(notice);
            setTimeout(() => notice.remove(), 2000);
        }

        function openLightbox(src) {
            const modal = document.getElementById('modal');
            document.getElementById('modalImg').src = src;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeLightbox() {
            document.getElementById('modal').classList.add('hidden');
        }

        function applyFilters() {
            const severityFilter = document.getElementById('filterSeverity').value;
            const validationFilter = document.getElementById('filterValidation').value;
            const cards = document.querySelectorAll('.finding-card');
            let visibleCount = 0;

            cards.forEach(card => {
                const severity = card.dataset.severity;
                const validated = card.dataset.validated === 'true';

                let showBySeverity = (severityFilter === 'all') || (severity === severityFilter);
                let showByValidation = (validationFilter === 'all') ||
                    (validationFilter === 'verified' && validated) ||
                    (validationFilter === 'potential' && !validated);

                if (showBySeverity && showByValidation) {
                    card.style.display = '';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            document.getElementById('visibleCount').textContent = visibleCount;

            // Update sidebar button highlights
            updateSidebarHighlights(severityFilter);
        }

        function filterBySeverity(severity) {
            // Set the dropdown value
            document.getElementById('filterSeverity').value = severity;
            // Apply filters (this also updates highlights)
            applyFilters();
            // Scroll to findings section
            document.getElementById('findingsContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function updateSidebarHighlights(activeSeverity) {
            const buttons = document.querySelectorAll('.severity-filter-btn');
            buttons.forEach(btn => {
                const btnSeverity = btn.dataset.severity;
                // Remove previous active state
                btn.classList.remove('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-slate-900');
                // Add active state if this is the selected severity
                if (btnSeverity === activeSeverity) {
                    btn.classList.add('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-slate-900');
                }
            });
        }

        function copyFindingMarkdown(index) {
            const finding = window.reportData.findings[index];
            const markdown = finding.markdown_block || (finding.metadata && finding.metadata.markdown_block);

            if (!markdown) {
                // Fallback generation if missing in JSON
                const url = finding.url || (finding.metadata && finding.metadata.url) || "Unknown URL";
                const payload = finding.payload || (finding.metadata && finding.metadata.payload) || "PAYLOAD";
                const md = `### ${finding.type}\n**URL:** ${url}\n**Payload:** \`${payload}\`\n\n### Steps\n1. Go to ${url}\n2. Inject payload`;
                copyToClipboard(md);
                return;
            }
            // Decode escaped newlines if necessary, usually JSON strings work fine
            copyToClipboard(markdown);
        }
    </script>
</body>

</html>