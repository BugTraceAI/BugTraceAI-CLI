<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ ctx.target_url }} | Security Assessment Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vuln-critical': '#991b1b',
                        'vuln-high': '#dc2626',
                        'vuln-medium': '#d97706',
                        'vuln-low': '#2563eb',
                        'vuln-info': '#059669',
                        'brand-slate': '#0f172a',
                        'brand-border': '#1e293b'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap');

        body {
            background-color: #f8fafc;
            color: #1e293b;
            font-family: 'Inter', sans-serif;
        }

        .sidebar {
            background-color: #0f172a;
        }

        .card {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            transition: border-color 0.2s;
        }

        .card:hover {
            border-color: #cbd5e1;
        }

        .badge {
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.65rem;
            padding: 0.25rem 0.5rem;
            letter-spacing: 0.05em;
            border-radius: 0.25rem;
        }

        code {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Print Styles */
        @media print {
            .no-print {
                display: none;
            }

            body {
                background: white;
            }

            .card {
                border: 1px solid #ddd;
                break-inside: avoid;
            }
        }
    </style>
</head>

<body class="min-h-screen flex flex-col md:flex-row">
    <!-- Sidebar / Header -->
    <aside class="w-full md:w-80 sidebar text-white flex flex-col no-print shrink-0 md:fixed md:h-screen">
        <div class="p-8">
            <div class="flex items-center gap-3 mb-8">
                <div class="w-10 h-10 bg-blue-600 rounded flex items-center justify-center font-bold text-xl">B</div>
                <h1 class="text-xl font-bold tracking-tight">Bugtrace<span class="text-blue-500">AI</span></h1>
            </div>

            <nav class="space-y-4">
                <div class="text-xs uppercase text-slate-500 font-bold tracking-widest mb-4">Assessment Context</div>
                <div>
                    <div class="text-sm text-slate-400 mb-1">Target Host</div>
                    <div class="font-mono text-sm break-all text-blue-400">{{ ctx.target_url }}</div>
                </div>
                <div>
                    <div class="text-sm text-slate-400 mb-1">Execution Date</div>
                    <div class="text-sm">{{ now }}</div>
                </div>
                <div>
                    <div class="text-sm text-slate-400 mb-1">Framework Version</div>
                    <div class="text-sm">v{{ ctx.tool_version }}</div>
                </div>
            </nav>

            <div class="mt-12 space-y-4">
                <div class="text-xs uppercase text-slate-500 font-bold tracking-widest mb-4">Risk Summary</div>
                <div class="space-y-2">
                    <div class="flex justify-between items-center bg-vuln-critical/10 p-2 rounded">
                        <span class="text-xs font-bold text-red-500">CRITICAL</span>
                        <span class="font-bold">{{ counts.critical }}</span>
                    </div>
                    <div class="flex justify-between items-center bg-vuln-high/10 p-2 rounded">
                        <span class="text-xs font-bold text-red-400">HIGH</span>
                        <span class="font-bold">{{ counts.high }}</span>
                    </div>
                    <div class="flex justify-between items-center bg-vuln-medium/10 p-2 rounded">
                        <span class="text-xs font-bold text-amber-500">MEDIUM</span>
                        <span class="font-bold">{{ counts.medium }}</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-auto p-8 border-t border-slate-800">
            <div class="text-[10px] text-slate-500 leading-relaxed uppercase tracking-tighter">
                Highly confidential security assessment. Unauthorized reproduction or distribution is prohibited.
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 md:ml-80 p-6 md:p-12">
        <div class="max-w-5xl mx-auto">
            <!-- Summary Dashboard -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-12">
                <div class="lg:col-span-2 card p-8 flex flex-col">
                    <h2 class="text-lg font-bold mb-6 flex items-center gap-2">
                        <i class="fas fa-chart-pie text-slate-400"></i>
                        Vulnerability Distribution
                    </h2>
                    <div class="flex flex-1 items-center justify-center p-4">
                        <div class="w-full max-w-[350px]">
                            <canvas id="riskChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div
                        class="card p-6 border-l-4 {% if counts.validated > 0 %}border-green-600 bg-green-50/30{% else %}border-amber-600 bg-amber-50/30{% endif %}">
                        <div class="text-xs text-slate-500 mb-1 font-bold">VALIDATION STATUS</div>
                        <div class="text-3xl font-bold">{{ counts.validated }}/{{ counts.total }}</div>
                        <div
                            class="text-xs {% if counts.validated > 0 %}text-green-600{% else %}text-amber-600{% endif %} mt-2">
                            {% if counts.validated > 0 %}‚úÖ Confirmed via Browser/SQLMap{% else %}‚ö†Ô∏è Potential (Requires
                            Validation){% endif %}
                        </div>
                    </div>
                    <div class="card p-6">
                        <div class="text-xs text-slate-500 mb-1 font-bold">URLs SCANNED</div>
                        <div class="text-3xl font-bold">{{ ctx.stats.urls_scanned }}</div>
                    </div>
                    <div class="card p-6">
                        <div class="text-xs text-slate-500 mb-1 font-bold">SCAN DURATION</div>
                        <div class="text-3xl font-bold">{{ ctx.stats.duration_seconds|round|int }}s</div>
                    </div>
                </div>
            </div>

            <!-- Findings List -->
            <div class="mb-8 flex flex-wrap items-center justify-between gap-4 border-b pb-4">
                <h2 class="text-2xl font-bold">Detailed Technical Findings</h2>
                <div class="flex flex-wrap items-center gap-3">
                    <!-- Severity Filter -->
                    <select id="filterSeverity" onchange="applyFilters()"
                        class="px-3 py-2 text-sm border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="all">All Severities</option>
                        <option value="Critical">üî¥ Critical</option>
                        <option value="High">üü† High</option>
                        <option value="Medium">üü° Medium</option>
                        <option value="Low">üîµ Low</option>
                        <option value="Information">üü¢ Info</option>
                    </select>

                    <!-- Validation Filter -->
                    <select id="filterValidation" onchange="applyFilters()"
                        class="px-3 py-2 text-sm border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="all">All Findings</option>
                        <option value="verified">‚úÖ Verified Only</option>
                        <option value="potential">‚ö†Ô∏è Potential Only</option>
                    </select>

                    <!-- Results Count -->
                    <span id="filterCount" class="text-sm text-slate-500 ml-2">
                        Showing <span id="visibleCount">{{ ctx.findings|length }}</span> of {{ ctx.findings|length }}
                    </span>
                </div>
            </div>

            <div id="findingsContainer" class="space-y-6">
                {% for finding in ctx.findings %}
                <div class="card overflow-hidden finding-card {% if not finding.validated %}border-l-4 border-amber-400{% endif %}"
                    data-severity="{{ finding.severity.value }}"
                    data-validated="{{ 'true' if finding.validated else 'false' }}" data-type="{{ finding.title }}">
                    <div class="p-6 border-b bg-slate-50/50 flex flex-wrap items-center justify-between gap-4">
                        <div class="flex items-center gap-4">
                            <span class="badge 
                                {% if finding.severity == 'Critical' %}bg-vuln-critical text-white
                                {% elif finding.severity == 'High' %}bg-vuln-high text-white
                                {% elif finding.severity == 'Medium' %}bg-vuln-medium text-white
                                {% elif finding.severity == 'Low' %}bg-vuln-low text-white
                                {% else %}bg-vuln-info text-white{% endif %}">
                                {{ finding.severity }}
                            </span>
                            {% if finding.validated %}
                            <span class="badge bg-green-600 text-white">‚úÖ VERIFIED</span>
                            {% else %}
                            <span class="badge bg-amber-500 text-white">‚ö†Ô∏è POTENTIAL</span>
                            {% endif %}
                            <h3 class="font-bold text-lg">{{ finding.title }}</h3>
                        </div>
                        <div class="text-xs font-mono text-slate-500 bg-white px-3 py-1 border rounded">
                            {{ finding.metadata.get('url', ctx.target_url) }}
                        </div>
                    </div>

                    <div class="p-8">
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-10">
                            <div class="md:col-span-12 lg:col-span-7 space-y-8">
                                <div>
                                    <h4 class="text-xs font-black text-slate-400 uppercase mb-3 tracking-widest">
                                        Executive Description</h4>
                                    <div class="bg-slate-900 rounded p-3 group relative">
                                        <code
                                            class="text-green-400 text-xs break-all leading-relaxed whitespace-pre-wrap font-mono">{{ finding.description }}</code>
                                        <button
                                            class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-slate-400 hover:text-white"
                                            onclick="copyToClipboard(this.previousElementSibling.innerText)">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- TRIAGER READY SECTION -->
                                <div class="bg-blue-50/50 p-6 rounded-lg border border-blue-100">
                                    <h4
                                        class="text-xs font-black text-blue-600 uppercase mb-4 tracking-widest flex items-center gap-2">
                                        <i class="fas fa-user-secret"></i> Triager Reproduction Steps
                                    </h4>

                                    <div class="bg-slate-900 rounded p-3 group relative">
                                        <ol
                                            class="list-decimal list-inside space-y-1 text-xs text-green-400 font-mono break-all">
                                            {% if finding.metadata.get('reproduction_steps') %}
                                            {% for step in finding.metadata.get('reproduction_steps') %}
                                            <li>{{ step }}</li>
                                            {% endfor %}
                                            {% else %}
                                            <li>Navigate to {{ finding.metadata.get('url', ctx.target_url) }}</li>
                                            <li>Identify the parameter '{{ finding.metadata.get('parameter',
                                                'target_param') }}'</li>
                                            <li>Inject the payload provided in the Technical Proof below.</li>
                                            <li>Observe the application response or behavior.</li>
                                            {% endif %}
                                        </ol>
                                        <button
                                            class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-slate-400 hover:text-white"
                                            onclick="copyToClipboard(this.previousElementSibling.innerText)">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>

                                    <div class="mt-6">
                                        <h4 class="text-[10px] font-black text-blue-400 uppercase mb-2 tracking-widest">
                                            Proof of Concept (Curl)
                                        </h4>
                                        <div class="bg-slate-900 rounded p-3 group relative">
                                            <code
                                                class="text-green-400 text-xs break-all leading-relaxed whitespace-pre-wrap font-mono">curl "{{ finding.metadata.get('url', ctx.target_url) }}" {% if finding.metadata.get('parameter') %}-d "{{ finding.metadata.get('parameter') }}={{ finding.metadata.get('payload', 'PAYLOAD')|urlencode }}"{% endif %}</code>
                                            <button
                                                class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-slate-400 hover:text-white"
                                                onclick="copyToClipboard(this.previousElementSibling.innerText)">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-8">
                                    <div>
                                        <h4 class="text-xs font-black text-red-400 uppercase mb-3 tracking-widest">Risk
                                            Impact</h4>
                                        <p class="text-sm text-slate-600">{{ finding.impact or "Direct compromise of
                                            target component." }}</p>
                                    </div>
                                    <div>
                                        <h4 class="text-xs font-black text-blue-500 uppercase mb-3 tracking-widest">
                                            Remediation Strategy</h4>
                                        <p class="text-sm text-slate-600">{{ finding.remediation or "Implement input
                                            sanitization and output encoding." }}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="md:col-span-12 lg:col-span-5 space-y-8">
                                {% if finding.evidence %}
                                <div>
                                    <h4 class="text-xs font-black text-slate-400 uppercase mb-3 tracking-widest">
                                        Technical Proof</h4>
                                    <div class="space-y-3">
                                        {% for ev in finding.evidence %}
                                        <div class="bg-slate-900 rounded p-4 group relative">
                                            <div class="text-[10px] text-slate-500 font-mono mb-2 uppercase">{{
                                                ev.description }}</div>
                                            <code
                                                class="text-green-400 text-xs break-all leading-relaxed whitespace-pre-wrap">{{ ev.content }}</code>
                                            <button
                                                class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-slate-400 hover:text-white"
                                                onclick="copyToClipboard('{{ ev.content|e }}')">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}

                                {% if finding.screenshot_path %}
                                <div>
                                    <h4 class="text-xs font-black text-slate-400 uppercase mb-3 tracking-widest">Browser
                                        Validation</h4>
                                    <div class="border rounded bg-slate-100 p-1 cursor-zoom-in group overflow-hidden"
                                        onclick="openLightbox('./{{ finding.screenshot_path }}')">
                                        <img src="./{{ finding.screenshot_path }}" alt="PoC"
                                            class="w-full h-auto grayscale-[0.5] group-hover:grayscale-0 transition-all duration-300">
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Audit Footer -->
            <footer
                class="mt-20 border-t pt-8 flex flex-col md:flex-row justify-between items-center text-slate-400 text-xs text-center md:text-left gap-4">
                <div>
                    <div class="font-bold mb-1">AUDIT SIGNATURE</div>
                    <div class="font-mono">HASH: {{ ctx.target_url|hash_id if ctx.target_url else "0xDEADBEEF" }}</div>
                </div>
                <div>
                    <p>¬© 2026 BugtraceAI Professional Edition</p>
                    <p>Generated for authorized compliance auditing only.</p>
                </div>
            </footer>
        </div>
    </main>

    <!-- Modal Lightbox -->
    <div id="modal"
        class="fixed inset-0 z-[100] bg-slate-900/95 hidden items-center justify-center p-4 md:p-12 no-print"
        onclick="closeLightbox()">
        <img id="modalImg" src="" class="max-w-full max-h-full shadow-2xl border-4 border-white rounded">
        <button class="absolute top-8 right-8 text-white text-4xl">&times;</button>
    </div>

    <script>
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            const notice = document.createElement('div');
            notice.className = 'fixed bottom-8 right-8 bg-slate-800 text-white px-6 py-3 rounded-full text-sm shadow-xl z-50';
            notice.innerText = 'Evidence copied to clipboard';
            document.body.appendChild(notice);
            setTimeout(() => notice.remove(), 2000);
        }

        function openLightbox(src) {
            const modal = document.getElementById('modal');
            document.getElementById('modalImg').src = src;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeLightbox() {
            document.getElementById('modal').classList.add('hidden');
        }

        // Filter functionality
        function applyFilters() {
            const severityFilter = document.getElementById('filterSeverity').value;
            const validationFilter = document.getElementById('filterValidation').value;
            const cards = document.querySelectorAll('.finding-card');
            let visibleCount = 0;

            cards.forEach(card => {
                const severity = card.dataset.severity;
                const validated = card.dataset.validated === 'true';

                let showBySeverity = (severityFilter === 'all') || (severity === severityFilter);
                let showByValidation = (validationFilter === 'all') ||
                    (validationFilter === 'verified' && validated) ||
                    (validationFilter === 'potential' && !validated);

                if (showBySeverity && showByValidation) {
                    card.style.display = '';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            document.getElementById('visibleCount').textContent = visibleCount;
        }

        // Risk Chart - Solid filled Radar Chart
        const chartCtx = document.getElementById('riskChart').getContext('2d');
        new Chart(chartCtx, {
            type: 'radar',
            data: {
                labels: ['Critical', 'High', 'Medium', 'Low', 'Info'],
                datasets: [{
                    label: 'Risk Vector',
                    data: [
                        {{ counts.critical }},
                {{ counts.high }}, 
                        {{ counts.medium }},
            {{ counts.low }},
            {{ counts.info }}
                    ],
            backgroundColor: 'rgba(37, 99, 235, 0.4)',
            borderColor: '#2563eb',
            borderWidth: 2,
            pointBackgroundColor: '#2563eb',
            fill: true
                }]
            },
            options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    ticks: { display: false, stepSize: 1 },
                    grid: { color: '#e2e8f0' },
                    angleLines: { color: '#e2e8f0' },
                    pointLabels: {
                        font: { size: 11, weight: 'bold' },
                        color: '#64748b'
                    }
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
        });
    </script>
</body>

</html>