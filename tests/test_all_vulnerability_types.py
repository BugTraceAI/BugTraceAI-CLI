#!/usr/bin/env python3
"""
Comprehensive Test: All 8 Vulnerability Types Against Dojo
Tests XSS, SQLi, SSRF, XXE, File Upload, CSTI, JWT, IDOR
"""

import asyncio
import sys
import time
sys.path.insert(0, '.')

from bugtrace.agents.xss_agent import XSSAgent
from bugtrace.agents.ssrf_agent import SSRFAgent
from bugtrace.agents.xxe_agent import XXEAgent
from bugtrace.agents.fileupload_agent import FileUploadAgent
from bugtrace.agents.jwt_agent import JWTAgent
from bugtrace.agents.idor_agent import IDORAgent
from bugtrace.agents.sqli_agent import SQLiAgent
from bugtrace.tools.exploitation.csti import CSTIDetector
from bugtrace.core.event_bus import event_bus
import httpx


async def test_xss_levels():
    """Test XSS agent against various difficulty levels"""
    print("\n" + "="*70)
    print("XSS AGENT TESTING")
    print("="*70)

    test_cases = [
        (0, "http://127.0.0.1:5090/xss/level0?q=test", "Trivial - No protection"),
        (2, "http://127.0.0.1:5090/xss/level2?q=test", "Easy - Script blacklist"),
        (4, "http://127.0.0.1:5090/xss/level4?q=test", "Medium - Context aware"),
        (6, "http://127.0.0.1:5090/xss/level6?q=test", "Hard - Basic WAF"),
        (7, "http://127.0.0.1:5090/xss/level7?q=test", "Hard - WAF + CSP (TARGET)"),
    ]

    results = []

    for level, url, description in test_cases:
        print(f"\nüîç Testing Level {level}: {description}")
        print(f"   URL: {url}")

        start = time.time()
        try:
            agent = XSSAgent(url=url, params=['q'], event_bus=event_bus, headless=True)
            result = await agent.run_loop()
            duration = time.time() - start

            if result and result.get('findings'):
                findings = result['findings']
                print(f"   ‚úÖ PASSED - Found {len(findings)} XSS in {duration:.1f}s")
                if findings:
                    payload = findings[0].get('payload', '')[:80]
                    print(f"   Payload: {payload}")
                results.append({'level': level, 'passed': True, 'time': duration, 'vulns': len(findings)})
            else:
                print(f"   ‚ùå FAILED - No XSS detected ({duration:.1f}s)")
                results.append({'level': level, 'passed': False, 'time': duration})

        except Exception as e:
            duration = time.time() - start
            print(f"   ‚ùå ERROR: {str(e)[:100]}")
            results.append({'level': level, 'passed': False, 'time': duration, 'error': str(e)})

        await asyncio.sleep(1)

    return results


async def test_sqli_levels():
    """Test SQLi detection against various difficulty levels"""
    print("\n" + "="*70)
    print("SQLi DETECTION TESTING")
    print("="*70)



    test_cases = [
        (0, "http://127.0.0.1:5090/sqli/level0?id=1", "Trivial - Error-based"),
        (2, "http://127.0.0.1:5090/sqli/level2?id=1", "Easy - Quote blocking"),
        (4, "http://127.0.0.1:5090/sqli/level4?id=1", "Medium - Prepared statements"),
        (6, "http://127.0.0.1:5090/sqli/level6?id=1", "Hard - Time-based blind"),
        (7, "http://127.0.0.1:5090/sqli/level7?id=1", "Hard - Advanced WAF (TARGET)"),
    ]

    results = []

    for level, url, description in test_cases:
        print(f"\nüîç Testing Level {level}: {description}")
        print(f"   URL: {url}")

        start = time.time()
        try:
            agent = SQLiAgent(url=url, param='id')
            result = await agent.run_loop()
            duration = time.time() - start

            if result and result.get('vulnerable'):
                msg = result['findings'][0].get('description', 'Confirmed')
                print(f"   ‚úÖ PASSED - Found SQLi in {duration:.1f}s")
                print(f"   Detection: {msg}")
                results.append({'level': level, 'passed': True, 'time': duration, 'message': msg})
            else:
                print(f"   ‚ùå FAILED - No SQLi detected ({duration:.1f}s)")
                results.append({'level': level, 'passed': False, 'time': duration})

        except Exception as e:
            print(f"   ‚ùå ERROR: {str(e)[:100]}")
            results.append({'level': level, 'passed': False, 'error': str(e)})

        await asyncio.sleep(1)

    return results


async def test_ssrf_levels():
    """Test SSRF agent against various difficulty levels"""
    print("\n" + "="*70)
    print("SSRF AGENT TESTING")
    print("="*70)

    test_cases = [
        (0, "http://127.0.0.1:5090/ssrf/level0", "url", "Trivial - No protection"),
        (2, "http://127.0.0.1:5090/ssrf/level2", "url", "Easy - Basic filtering"),
        (4, "http://127.0.0.1:5090/ssrf/level4", "url", "Medium - IP blocking"),
        (6, "http://127.0.0.1:5090/ssrf/level6", "url", "Hard - Protocol filtering"),
        (7, "http://127.0.0.1:5090/ssrf/level7", "url", "Hard - Advanced WAF (TARGET)"),
    ]

    results = []

    for level, url, param, description in test_cases:
        print(f"\nüîç Testing Level {level}: {description}")
        print(f"   URL: {url}")

        start = time.time()
        try:
            agent = SSRFAgent(url=url, param=param)
            result = await agent.run_loop()
            duration = time.time() - start

            if result and result.get('vulnerable'):
                findings = result.get('findings', [])
                print(f"   ‚úÖ PASSED - Found SSRF in {duration:.1f}s")
                if findings:
                    print(f"   Payload: {findings[0].get('payload', '')[:80]}")
                results.append({'level': level, 'passed': True, 'time': duration, 'vulns': len(findings)})
            else:
                print(f"   ‚ùå FAILED - No SSRF detected ({duration:.1f}s)")
                results.append({'level': level, 'passed': False, 'time': duration})

        except Exception as e:
            duration = time.time() - start
            print(f"   ‚ùå ERROR: {str(e)[:100]}")
            results.append({'level': level, 'passed': False, 'time': duration, 'error': str(e)})

        await asyncio.sleep(1)

    return results


async def test_xxe_levels():
    """Test XXE agent against various difficulty levels"""
    print("\n" + "="*70)
    print("XXE AGENT TESTING")
    print("="*70)

    test_cases = [
        (0, "http://127.0.0.1:5090/xxe/level0", "Trivial - No protection"),
        (1, "http://127.0.0.1:5090/xxe/level1", "Easy - SYSTEM blocked"),
        (2, "http://127.0.0.1:5090/xxe/level2", "Easy - External entity disabled"),
        (4, "http://127.0.0.1:5090/xxe/level4", "Medium - DTD filtering"),
        (6, "http://127.0.0.1:5090/xxe/level6", "Hard - Content-type filtering"),
        (7, "http://127.0.0.1:5090/xxe/level7", "Hard - Advanced WAF (TARGET)"),
    ]

    results = []

    for level, url, description in test_cases:
        print(f"\nüîç Testing Level {level}: {description}")
        print(f"   URL: {url}")

        start = time.time()
        try:
            agent = XXEAgent(url=url)
            result = await agent.run_loop()
            duration = time.time() - start

            if result and result.get('vulnerable'):
                findings = result.get('findings', [])
                print(f"   ‚úÖ PASSED - Found XXE in {duration:.1f}s")
                if findings:
                    print(f"   Type: {findings[0].get('description', '')[:80]}")
                results.append({'level': level, 'passed': True, 'time': duration, 'vulns': len(findings)})
            else:
                print(f"   ‚ùå FAILED - No XXE detected ({duration:.1f}s)")
                results.append({'level': level, 'passed': False, 'time': duration})

        except Exception as e:
            duration = time.time() - start
            print(f"   ‚ùå ERROR: {str(e)[:100]}")
            results.append({'level': level, 'passed': False, 'time': duration, 'error': str(e)})

        await asyncio.sleep(1)

    return results


async def test_fileupload_levels():
    """Test File Upload agent against various difficulty levels"""
    print("\n" + "="*70)
    print("FILE UPLOAD AGENT TESTING")
    print("="*70)

    test_cases = [
        (0, "http://127.0.0.1:5090/upload/level0", "Trivial - No validation"),
        (2, "http://127.0.0.1:5090/upload/level2", "Easy - Extension check"),
        (4, "http://127.0.0.1:5090/upload/level4", "Medium - MIME check"),
        (6, "http://127.0.0.1:5090/upload/level6", "Hard - Content check"),
        (7, "http://127.0.0.1:5090/upload/level7", "Hard - Advanced validation (TARGET)"),
    ]

    results = []

    for level, url, description in test_cases:
        print(f"\nüîç Testing Level {level}: {description}")
        print(f"   URL: {url}")

        start = time.time()
        try:
            agent = FileUploadAgent(url=url)
            result = await agent.run_loop()
            duration = time.time() - start

            if result and result.get('vulnerable'):
                findings = result.get('findings', [])
                print(f"   ‚úÖ PASSED - Found File Upload vuln in {duration:.1f}s")
                if findings:
                    print(f"   Method: {findings[0].get('method', '')[:80]}")
                results.append({'level': level, 'passed': True, 'time': duration, 'vulns': len(findings)})
            else:
                print(f"   ‚ùå FAILED - No File Upload vuln detected ({duration:.1f}s)")
                results.append({'level': level, 'passed': False, 'time': duration})

        except Exception as e:
            duration = time.time() - start
            print(f"   ‚ùå ERROR: {str(e)[:100]}")
            results.append({'level': level, 'passed': False, 'time': duration, 'error': str(e)})

        await asyncio.sleep(1)

    return results


async def test_csti_levels():
    """Test CSTI detection against various difficulty levels"""
    print("\n" + "="*70)
    print("CSTI DETECTION TESTING")
    print("="*70)

    detector = CSTIDetector()

    test_cases = [
        (0, "http://127.0.0.1:5090/csti/level0?name=test", "Trivial - No escaping"),
        (1, "http://127.0.0.1:5090/csti/level1?name=test", "Easy - Blocks {{"),
        (2, "http://127.0.0.1:5090/csti/level2?name=test", "Easy - Basic sanitization"),
        (4, "http://127.0.0.1:5090/csti/level4?name=test", "Medium - CSP protection"),
        (6, "http://127.0.0.1:5090/csti/level6?name=test", "Hard - Framework hardening"),
        (7, "http://127.0.0.1:5090/csti/level7?name=test", "Hard - Advanced WAF (TARGET)"),
    ]

    results = []

    for level, url, description in test_cases:
        print(f"\nüîç Testing Level {level}: {description}")
        print(f"   URL: {url}")

        start = time.time()
        try:
            result = await detector.check(url)
            duration = time.time() - start

            if result:
                msg = result
                print(f"   ‚úÖ PASSED - Found CSTI in {duration:.1f}s")
                print(f"   Detection: {msg}")
                results.append({'level': level, 'passed': True, 'time': duration, 'message': msg})
            else:
                print(f"   ‚ùå FAILED - No CSTI detected ({duration:.1f}s)")
                results.append({'level': level, 'passed': False, 'time': duration})

        except Exception as e:
            duration = time.time() - start
            print(f"   ‚ùå ERROR: {str(e)[:100]}")
            results.append({'level': level, 'passed': False, 'time': duration, 'error': str(e)})

        await asyncio.sleep(1)

    return results


async def test_jwt_levels():
    """Test JWT agent against various difficulty levels"""
    print("\n" + "="*70)
    print("JWT AGENT TESTING")
    print("="*70)

    test_cases = [
        (0, "http://127.0.0.1:5090/jwt/level0", "Trivial - No validation"),
        (2, "http://127.0.0.1:5090/jwt/level2", "Easy - Algorithm confusion"),
        (4, "http://127.0.0.1:5090/jwt/level4", "Medium - Weak secret"),
        (6, "http://127.0.0.1:5090/jwt/level6", "Hard - Key injection"),
        (7, "http://127.0.0.1:5090/jwt/level7", "Hard - Advanced attacks (TARGET)"),
    ]

    results = []

    for level, url, description in test_cases:
        print(f"\nüîç Testing Level {level}: {description}")
        print(f"   URL: {url}")

        start = time.time()
        try:
            agent = JWTAgent() # event_bus is optional and not needed for check_url
            result = await agent.check_url(url)
            duration = time.time() - start

            if result and result.get('vulnerable'):
                findings = result.get('findings', [])
                print(f"   ‚úÖ PASSED - Found JWT vuln in {duration:.1f}s")
                if findings:
                    print(f"   Type: {findings[0].get('description', '')[:80]}")
                results.append({'level': level, 'passed': True, 'time': duration, 'vulns': len(findings)})
            else:
                print(f"   ‚ùå FAILED - No JWT vuln detected ({duration:.1f}s)")
                results.append({'level': level, 'passed': False, 'time': duration})

        except Exception as e:
            duration = time.time() - start
            print(f"   ‚ùå ERROR: {str(e)[:100]}")
            results.append({'level': level, 'passed': False, 'time': duration, 'error': str(e)})

        await asyncio.sleep(1)

    return results


async def test_idor_levels():
    """Test IDOR agent against various difficulty levels"""
    print("\n" + "="*70)
    print("IDOR AGENT TESTING")
    print("="*70)

    test_cases = [
        (0, "http://127.0.0.1:5090/idor/level0?id=1", "Trivial - No auth"),
        (1, "http://127.0.0.1:5090/idor/level1?id=1", "Easy - Predictable IDs"),
        (2, "http://127.0.0.1:5090/idor/level2?id=1", "Easy - Predictable IDs"),
        (4, "http://127.0.0.1:5090/idor/level4?id=1", "Medium - Session check"),
        (6, "http://127.0.0.1:5090/idor/level6?id=1", "Hard - UUID + auth"),
        (7, "http://127.0.0.1:5090/idor/level7?id=1", "Hard - Full access control (TARGET)"),
    ]

    results = []

    for level, url, description in test_cases:
        print(f"\nüîç Testing Level {level}: {description}")
        print(f"   URL: {url}")

        start = time.time()
        try:
            # IDOR agent requires: url, param, original_value
            agent = IDORAgent(url=url, param='id', original_value='1')
            result = await agent.run_loop()
            duration = time.time() - start

            if result and result.get('vulnerable'):
                findings = result.get('findings', [])
                print(f"   ‚úÖ PASSED - Found IDOR in {duration:.1f}s")
                if findings:
                    print(f"   Access: {findings[0].get('description', '')[:80]}")
                results.append({'level': level, 'passed': True, 'time': duration, 'vulns': len(findings)})
            else:
                print(f"   ‚ùå FAILED - No IDOR detected ({duration:.1f}s)")
                results.append({'level': level, 'passed': False, 'time': duration})

        except Exception as e:
            duration = time.time() - start
            print(f"   ‚ùå ERROR: {str(e)[:100]}")
            results.append({'level': level, 'passed': False, 'time': duration, 'error': str(e)})

        await asyncio.sleep(1)

    return results


async def test_basic_connectivity():
    """Test basic connectivity to all vulnerability types"""
    print("\n" + "="*70)
    print("BASIC CONNECTIVITY TEST")
    print("="*70)

    endpoints = [
        ("/xss/level0?q=test", "XSS"),
        ("/sqli/level0?id=1", "SQLi"),
        ("/ssrf/level0?url=http://example.com", "SSRF"),
        ("/xxe/level0", "XXE"),
        ("/upload/level0", "File Upload"),
        ("/csti/level0?name=test", "CSTI"),
        ("/jwt/level0?token=test", "JWT"),
        ("/idor/level0?id=1", "IDOR"),
    ]

    async with httpx.AsyncClient(timeout=5) as client:
        for path, vuln_type in endpoints:
            url = f"http://127.0.0.1:5090{path}"
            try:
                response = await client.get(url)
                if response.status_code < 500:
                    print(f"‚úÖ {vuln_type:15s} - Endpoint responding ({response.status_code})")
                else:
                    print(f"‚ùå {vuln_type:15s} - Server error ({response.status_code})")
            except Exception as e:
                print(f"‚ùå {vuln_type:15s} - Connection failed: {str(e)[:50]}")


async def main():
    """Run comprehensive test for all vulnerability types"""
    print("\n")
    print("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó")
    print("‚ïë  BugTraceAI - Complete Vulnerability Assessment (8 Types)        ‚ïë")
    print("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù")

    # Test connectivity
    await test_basic_connectivity()

    # Test all vulnerability types
    xss_results = await test_xss_levels()
    sqli_results = await test_sqli_levels()
    # xss_results = [] # Skipped
    # sqli_results = [] # Skipped
    ssrf_results = await test_ssrf_levels()
    xxe_results = await test_xxe_levels()
    fileupload_results = await test_fileupload_levels()
    csti_results = await test_csti_levels()
    jwt_results = await test_jwt_levels()
    idor_results = await test_idor_levels()

    # Summary
    print("\n" + "="*70)
    print("COMPREHENSIVE SUMMARY - ALL VULNERABILITY TYPES")
    print("="*70)

    all_results = [
        ("XSS", xss_results),
        ("SQLi", sqli_results),
        ("SSRF", ssrf_results),
        ("XXE", xxe_results),
        ("File Upload", fileupload_results),
        ("CSTI", csti_results),
        ("JWT", jwt_results),
        ("IDOR", idor_results),
    ]

    total_tests = 0
    total_passed = 0

    for vuln_type, results in all_results:
        passed = sum(1 for r in results if r.get('passed'))
        total = len(results)
        total_tests += total
        total_passed += passed

        rate = (passed/total*100) if total > 0 else 0
        max_level = max([r['level'] for r in results if r.get('passed')], default=-1)

        status = "‚úÖ" if rate >= 60 else "‚ö†Ô∏è" if rate >= 40 else "‚ùå"

        print(f"\n{status} {vuln_type}:")
        print(f"   Passed: {passed}/{total} ({rate:.1f}%)")
        print(f"   Max Level: {max_level}")

    print("\n" + "="*70)
    print("OVERALL STATISTICS")
    print("="*70)

    overall_rate = (total_passed/total_tests*100) if total_tests > 0 else 0
    print(f"\nTotal Tests: {total_tests}")
    print(f"Total Passed: {total_passed}")
    print(f"Overall Success Rate: {overall_rate:.1f}%")

    if overall_rate >= 70:
        print("\n‚úÖ EXCELLENT - Production ready!")
    elif overall_rate >= 50:
        print("\n‚ö†Ô∏è  GOOD - Needs improvement for production")
    else:
        print("\n‚ùå NEEDS WORK - Below production standards")

    print("="*70 + "\n")


if __name__ == "__main__":
    asyncio.run(main())
